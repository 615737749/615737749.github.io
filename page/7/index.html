<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.6.0/css/all.min.css" integrity="sha256-5eIC48iZUHmSlSUz9XtjRyK2mzQkHScZY1WdMaoz74E=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"615737749.github.io","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.21.1","exturl":false,"sidebar":{"position":"right","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":false,"copycode":{"enable":true,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":true,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":false,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script>

    <meta property="og:type" content="website">
<meta property="og:title" content="porridgechen890的笔记">
<meta property="og:url" content="https://615737749.github.io/page/7/index.html">
<meta property="og:site_name" content="porridgechen890的笔记">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="porridgechen890">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://615737749.github.io/page/7/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"page/7/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>porridgechen890的笔记</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">porridgechen890的笔记</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">梦里不知身是客</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签<span class="badge">13</span></a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类<span class="badge">7</span></a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档<span class="badge">79</span></a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">porridgechen890</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">79</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">7</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">13</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://615737749.github.io/2021/05/14/03Knowledge/ios/ios002/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="porridgechen890">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="porridgechen890的笔记">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | porridgechen890的笔记">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/05/14/03Knowledge/ios/ios002/" class="post-title-link" itemprop="url">applovin max ios</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-05-14 10:25:33" itemprop="dateCreated datePublished" datetime="2021-05-14T10:25:33+08:00">2021-05-14</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/03%E7%9F%A5%E8%AF%86%E7%82%B9/" itemprop="url" rel="index"><span itemprop="name">03知识点</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><a target="_blank" rel="noopener" href="https://dash.applovin.com/documentation/mediation/ios/getting-started/integration">官网文档</a></p>
<h1 id="环境要求"><a href="#环境要求" class="headerlink" title="环境要求"></a>环境要求</h1><p>Xcode的版本要大于等于12。iOS deployment target要大于等于9.0。</p>
<h1 id="通过CocoaPods下载SDK"><a href="#通过CocoaPods下载SDK" class="headerlink" title="通过CocoaPods下载SDK"></a>通过CocoaPods下载SDK</h1><p>先添加 <code>pod &#39;AppLovinSDK&#39;</code> 到Podfile。如果要集成其他的平台，在在<a target="_blank" rel="noopener" href="https://dash.applovin.com/documentation/mediation/ios/mediation-adapters?network=GOOGLE_AD_MANAGER_NETWORK">这里</a>通过勾选来生成。</p>
<p>再在终端里执行 <code>pod install --repo-update</code> 。</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2021/05/14/03Knowledge/ios/ios002/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://615737749.github.io/2021/05/11/05History/History003/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="porridgechen890">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="porridgechen890的笔记">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | porridgechen890的笔记">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/05/11/05History/History003/" class="post-title-link" itemprop="url">秦淮八艳之柳如是</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-05-11 00:04:03" itemprop="dateCreated datePublished" datetime="2021-05-11T00:04:03+08:00">2021-05-11</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/05%E5%8E%86%E5%8F%B2/" itemprop="url" rel="index"><span itemprop="name">05历史</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>陈寅恪为之作传。王国维为之作诗。八大山人为她的画题跋。</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2021/05/11/05History/History003/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://615737749.github.io/2021/05/10/02Tool/cocoapods/cocoapods001/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="porridgechen890">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="porridgechen890的笔记">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | porridgechen890的笔记">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/05/10/02Tool/cocoapods/cocoapods001/" class="post-title-link" itemprop="url">macos安装cocoapods</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-05-10 23:26:35" itemprop="dateCreated datePublished" datetime="2021-05-10T23:26:35+08:00">2021-05-10</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/02%E5%B7%A5%E5%85%B7/" itemprop="url" rel="index"><span itemprop="name">02工具</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>查看ruby的版本<br>ruby -v</p>
<p>查看gem的版本<br>gem -v</p>
<p>查看gem的源<br>gem sources -l</p>
<p>通过gem下载cocoapods<br>sudo gem install cocoapods<br>我尝试过不加sudo报错如下：</p>
<pre><code class="highlight plaintext">ERROR:  While executing gem ... (Gem::FilePermissionError)
    You don&#x27;t have write permissions for the /Library/Ruby/Gems/2.6.0 directory.</code></pre>

<p>网上说下载完成后还要执行pod setup。我执行了一下，瞬间完成。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://615737749.github.io/2021/05/10/03Knowledge/ios/ios001/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="porridgechen890">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="porridgechen890的笔记">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | porridgechen890的笔记">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/05/10/03Knowledge/ios/ios001/" class="post-title-link" itemprop="url">将 Firebase 添加至您的 iOS 项目</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-05-10 17:57:09" itemprop="dateCreated datePublished" datetime="2021-05-10T17:57:09+08:00">2021-05-10</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/03%E7%9F%A5%E8%AF%86%E7%82%B9/" itemprop="url" rel="index"><span itemprop="name">03知识点</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><a target="_blank" rel="noopener" href="https://firebase.google.cn/docs/ios/setup">官网文档</a></p>
<h1 id="生成并添加配置文件"><a href="#生成并添加配置文件" class="headerlink" title="生成并添加配置文件"></a>生成并添加配置文件</h1><ol>
<li>在 Firebase 控制台里创建项目，并填入 iOS 项目的 Bundle Identifier</li>
<li>下载 GoogleService-Info.plist 文件，在 Xcode 中以 Create groups 的方式添加该文件。</li>
</ol>
<h1 id="同步库文件"><a href="#同步库文件" class="headerlink" title="同步库文件"></a>同步库文件</h1><ol>
<li>在 <code>xxx.xcodeproj</code>文件所在的目录下打开终端，使用 <code>pod init</code> 命令生成 <code>Podfile</code> 文件。</li>
<li>打开 <code>Podfile</code> ，写入如下内容： <pre><code class="highlight plaintext">platform :ios, &#x27;10.0&#x27;
target &#x27;xxx-mobile&#x27; do
pod &#x27;Firebase/Analytics&#x27;
pod &#x27;Firebase/Auth&#x27;
pod &#x27;Firebase/Firestore&#x27;
end</code></pre></li>
<li>使用 <code>pod install --repo-update</code> 命令下载第三方库。</li>
</ol>
<h1 id="初始化Firebase"><a href="#初始化Firebase" class="headerlink" title="初始化Firebase"></a>初始化Firebase</h1><ol>
<li>下载第三方库成功后，打开 <code>xxx.xcworkspace</code> 文件。</li>
<li>在 <code>AppController.mm</code> 文件里包含头文件 <code>#import &lt;Firebase.h&gt;</code> 。</li>
<li>在 <code>didFinishLaunchingWithOptions</code> 函数中添加初始化的代码 <code>[FIRApp configure]</code> 。</li>
</ol>
<h1 id="运行报错"><a href="#运行报错" class="headerlink" title="运行报错"></a>运行报错</h1><p>我遇到了这样一个错误<code>Undefined symbol: _OBJC_CLASS_$_FIRApp</code><br/><br>在执行 <code>pod update</code> 和 <code>pod install</code> 的时候，需要留意下面的那些提示，比如：<br/></p>
<pre><code class="highlight plaintext">[!] The `work_crush_bonbons-mobile [Release]` target overrides the `GCC_PREPROCESSOR_DEFINITIONS` build setting defined in `Pods/Target Support Files/Pods-work_crush_bonbons-mobile/Pods-work_crush_bonbons-mobile.release.xcconfig&#x27;. This can lead to problems with the CocoaPods installation
    - Use the `$(inherited)` flag, or
    - Remove the build settings from the target.</code></pre>
<p>然后我就按照它的提示，去找到 <code>GCC_PREPROCESSOR_DEFINITIONS</code> 这个设置，然后加上 <code>$(inherited)</code> ，再次执行 <code>pod update</code> 和 <code>pod install</code> 就可以了。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://615737749.github.io/2021/05/06/03Knowledge/cocos2dx/cocos2dx003/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="porridgechen890">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="porridgechen890的笔记">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | porridgechen890的笔记">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/05/06/03Knowledge/cocos2dx/cocos2dx003/" class="post-title-link" itemprop="url">cocos2dx屏幕适配</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-05-06 11:56:40" itemprop="dateCreated datePublished" datetime="2021-05-06T11:56:40+08:00">2021-05-06</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/03%E7%9F%A5%E8%AF%86%E7%82%B9/" itemprop="url" rel="index"><span itemprop="name">03知识点</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="为什么需要适配"><a href="#为什么需要适配" class="headerlink" title="为什么需要适配"></a>为什么需要适配</h1><p>因为设计分辨率和实际分辨率不一致。</p>
<h1 id="适配策略"><a href="#适配策略" class="headerlink" title="适配策略"></a>适配策略</h1><p>cocos2dx提供了下面5种适配策略</p>
<ul>
<li><p>设计分辨率的宽高比 &#x3D; 实际分辨率的宽高比</p>
<ul>
<li>只需要放大或者缩小</li>
</ul>
</li>
<li><p>设计分辨率的宽高比 ≠ 实际分辨率的宽高</p>
<ul>
<li>变形缩放<ul>
<li>拉伸变形，能保证宽和高都撑满，对应 <code>EXACT_FIT</code></li>
</ul>
</li>
<li>不变形缩放<ul>
<li>一直缩放，直到宽和高都撑满，不留黑边，对应 <code>NO_BORDER</code></li>
<li>宽或高刚撑满就不缩放了，另一个方向就会留黑边，对应 <code>SHOW_ALL</code></li>
<li>宽缩放到撑满就停，不管高撑满没有，对应 <code>FIXED_WIDTH</code></li>
<li>高缩放到撑满就停，不管宽撑满没有，对应 <code>FIXED_HEIGHT</code></li>
</ul>
</li>
</ul>
</li>
</ul>
<h1 id="推荐做法"><a href="#推荐做法" class="headerlink" title="推荐做法"></a>推荐做法</h1><p>如果是竖屏游戏，可以用定宽策略，只需要把素材做的高一点。</p>
<p>如果是横屏游戏，可以用定高策略，只需要把素材做的宽一点。</p>
<h1 id="给美术出图的建议"><a href="#给美术出图的建议" class="headerlink" title="给美术出图的建议"></a>给美术出图的建议</h1><p>目前我遇到的设备最大的长宽比是2.3。如果一个竖屏游戏的设计分辨率是 <code>480*800</code> ，那么背景图的高应该是 <code>480*2.3=1104</code> 。</p>
<h1 id="程序如何在代码中动态调整UI元素的位置"><a href="#程序如何在代码中动态调整UI元素的位置" class="headerlink" title="程序如何在代码中动态调整UI元素的位置"></a>程序如何在代码中动态调整UI元素的位置</h1><p>我推荐的做法是中心点对齐。然后四个边的某些UI元素需要动态设置位置。</p>
<p>如果是竖屏定宽模式，那么顶部和底部的元素需要调整位置，利用<code>可视区域原点</code>和<code>可视区域尺寸</code>来做修改。</p>
<h1 id="关于刘海屏"><a href="#关于刘海屏" class="headerlink" title="关于刘海屏"></a>关于刘海屏</h1><p>现在安卓和苹果都有刘海屏，刘海屏需要在代码中获取刘海高度来做动态调整。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://615737749.github.io/2021/04/30/02Tool/TexturePacker/TexturePacker001/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="porridgechen890">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="porridgechen890的笔记">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | porridgechen890的笔记">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/04/30/02Tool/TexturePacker/TexturePacker001/" class="post-title-link" itemprop="url">使用 Texture Packer 合图</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-04-30 14:27:55" itemprop="dateCreated datePublished" datetime="2021-04-30T14:27:55+08:00">2021-04-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/02%E5%B7%A5%E5%85%B7/" itemprop="url" rel="index"><span itemprop="name">02工具</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <ol>
<li><p>打开TexturePacker。我目前用的版本是 5.2.0。</p>
</li>
<li><p>数据格式选择cocos2d-x</p>
</li>
<li><p>拖入要打包的图</p>
</li>
<li><p>选择纹理格式</p>
</li>
<li><p>点击发布精灵表，选择保存路径，写上保存为的文件名。</p>
</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://615737749.github.io/2021/04/25/03Knowledge/cocos2dx/cocos2dx001/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="porridgechen890">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="porridgechen890的笔记">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | porridgechen890的笔记">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/04/25/03Knowledge/cocos2dx/cocos2dx001/" class="post-title-link" itemprop="url">安卓应用集成微信分享</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-04-25 15:31:39" itemprop="dateCreated datePublished" datetime="2021-04-25T15:31:39+08:00">2021-04-25</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/03%E7%9F%A5%E8%AF%86%E7%82%B9/" itemprop="url" rel="index"><span itemprop="name">03知识点</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="官方文档"><a href="#官方文档" class="headerlink" title="官方文档"></a>官方文档</h1><ul>
<li><p><a target="_blank" rel="noopener" href="https://open.weixin.qq.com/">微信开放平台</a></p>
</li>
<li><p>本文的介绍的是cocos2dx安卓平台接入微信分享功能（PS:微信登陆功能要给钱才能有）。参考的文档在“资源中心”-&gt;“移动应用”-&gt;“接入指南”-&gt;“Android接入指南”。</p>
</li>
</ul>
<h1 id="创建应用"><a href="#创建应用" class="headerlink" title="创建应用"></a>创建应用</h1><p>登录微信开放平台后，“管理中心”-&gt;“移动应用”-&gt;“创建移动应用”。</p>
<p>创建应用的过程还挺繁琐的，需要手持身份证的照片，还需要APP的运行流程图。我记得以前没这么复杂的。</p>
<p>还有就是未上架的应用在使用登陆、分享等功能的时候，都有1天100次这样的限制。</p>
<p>假设你创建好了应用并且审核通过了，就会得到AppID和AppSecret。</p>
<p>“分享到朋友圈”和“发送给朋友”这两个功能是默认给你使用的。</p>
<p>但是“微信登录”、“微信支付”等功能是要认证过的开发者才有的。那么认证开发者需要什么呢？钱。</p>
<h1 id="代码里要做的"><a href="#代码里要做的" class="headerlink" title="代码里要做的"></a>代码里要做的</h1><ol>
<li><p>用 Android Studio 打开工程，在模块级的 build.gradle 文件中添加微信所需的依赖项<br> <code>implementation &#39;com.tencent.mm.opensdk:wechat-sdk-android-without-mta:+&#39;</code></p>
<blockquote>
<p>官方文档上写的 <code>+</code> ，有时候同步不下来，在 <code>External Libraries</code> 那里没看到微信的包。<br> 然后参考了<a target="_blank" rel="noopener" href="https://blog.csdn.net/campchan/article/details/80229527">这篇文章</a><br> 也就是去<a target="_blank" rel="noopener" href="https://bintray.com/wechat-sdk-team/maven">这里</a>搜 <code>wechat-sdk</code> 就能看到最新的版本号。然后把加号改成版本号就行了。我这会儿用的是 <code>6.6.23</code> 。</p>
</blockquote>
</li>
<li><p>在 AndroidManifest.xml 文件里需要申请权限。</p>
</li>
<li><p>在程序启动时注册到微信。大概是这个样子：</p>
 <pre><code class="highlight java"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AppActivity</span> <span class="keyword">extends</span> <span class="title class_">Cocos2dxActivity</span> &#123;

    <span class="comment">// APP_ID 替换为你的应用从官方网站申请到的合法appID</span>
    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">APP_ID</span> <span class="operator">=</span> <span class="string">&quot;你的APP ID&quot;</span>;
    <span class="comment">// IWXAPI 是第三方app和微信通信的openApi接口</span>
    <span class="keyword">public</span> <span class="keyword">static</span> IWXAPI api;

    <span class="meta">@Override</span>
    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;
        <span class="comment">// DO OTHER INITIALIZATION BELOW</span>
        regToWx();
    &#125;
    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">regToWx</span><span class="params">()</span> &#123;
        <span class="comment">// 通过WXAPIFactory工厂，获取IWXAPI的实例</span>
        api = WXAPIFactory.createWXAPI(<span class="built_in">this</span>, APP_ID, <span class="literal">false</span>);
        <span class="comment">// 将应用的appId注册到微信</span>
        api.registerApp(APP_ID);
    &#125;
&#125;</code></pre>
</li>
<li><p>发送文本给朋友的示例</p>
 <pre><code class="highlight java"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AppActivity</span> <span class="keyword">extends</span> <span class="title class_">Cocos2dxActivity</span> &#123;

    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">share_text_to_friend</span><span class="params">(<span class="keyword">final</span> String s)</span> &#123;
        <span class="comment">//初始化一个 WXTextObject 对象，填写分享的文本内容</span>
        <span class="type">WXTextObject</span> <span class="variable">textObj</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">WXTextObject</span>();
        textObj.text = s;

        <span class="comment">//用 WXTextObject 对象初始化一个 WXMediaMessage 对象</span>
        <span class="type">WXMediaMessage</span> <span class="variable">msg</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">WXMediaMessage</span>();
        msg.mediaObject = textObj;
        msg.description = s;

        SendMessageToWX.<span class="type">Req</span> <span class="variable">req</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SendMessageToWX</span>.Req();
        req.transaction = String.valueOf(System.currentTimeMillis());  <span class="comment">//transaction字段用与唯一标示一个请求</span>
        req.message = msg;
        req.scene = WXSceneSession;

        <span class="comment">//调用api接口，发送数据到微信</span>
        api.sendReq(req);
    &#125;
&#125;</code></pre>
</li>
<li><p>到这里，应该能拉起微信分享了。如果提示“签名不对，请检查签名是否与开放平台上填写的一致。”<br> 在“资源中心”-&gt;“资源下载”-&gt;“Android资源下载”-&gt;“签名生成工具”。<br> 用这个apk输入你的报名，用得到的字符串，更新应用签名。</p>
</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://615737749.github.io/2021/04/23/03Knowledge/ios/ios003/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="porridgechen890">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="porridgechen890的笔记">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | porridgechen890的笔记">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/04/23/03Knowledge/ios/ios003/" class="post-title-link" itemprop="url">ios14获取IDFA</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-04-23 17:53:44" itemprop="dateCreated datePublished" datetime="2021-04-23T17:53:44+08:00">2021-04-23</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/03%E7%9F%A5%E8%AF%86%E7%82%B9/" itemprop="url" rel="index"><span itemprop="name">03知识点</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="苹果新推行的隐私政策"><a href="#苹果新推行的隐私政策" class="headerlink" title="苹果新推行的隐私政策"></a>苹果新推行的隐私政策</h1><p><a target="_blank" rel="noopener" href="https://developer.apple.com/cn/news/?id=ecvrtzt2">即将实行的 AppTrackingTransparency 要求 - 新闻 - Apple Developer</a></p>
<h1 id="背景知识"><a href="#背景知识" class="headerlink" title="背景知识"></a>背景知识</h1><ul>
<li>什么是IDFA<br>IDFA全称为 Identity for Advertisers ，即广告标识符。用来标记用户，目前最广泛的用途是用于投放广告、个性化推荐等。</li>
<li>怎么获取IDFA<br>在 iOS13 及以前，系统会默认为用户开启允许追踪设置，我们可以简单的通过代码来获取到用户的 IDFA 标识符。  <pre><code class="highlight objc"><span class="keyword">if</span> ([[ASIdentifierManager sharedManager] isAdvertisingTrackingEnabled]) &#123;
	<span class="built_in">NSString</span> *idfaString = [[ASIdentifierManager sharedManager] advertisingIdentifier].UUIDString;
	<span class="built_in">NSLog</span>(<span class="string">@&quot;%@&quot;</span>, idfaString);
&#125;</code></pre>
  但是在 iOS14 中，这个判断用户是否允许被追踪的方法已经废弃。<br>   iOS14 中，系统会默认为用户关闭广告追踪权限。</li>
</ul>
<h1 id="iOS14怎么获取IDFA"><a href="#iOS14怎么获取IDFA" class="headerlink" title="iOS14怎么获取IDFA"></a>iOS14怎么获取IDFA</h1><p>接着使用 AppTrackingTransparency 框架中的 ATTrackingManager 中的 requestTrackingAuthorizationWithCompletionHandler 请求用户权限，在用户授权后再去访问 IDFA 才能够获取到正确信息。</p>
<ul>
<li>首先需要在Info.plist配置权限申请的文案  <pre><code class="highlight plaintext">&lt;key&gt;NSUserTrackingUsageDescription&lt;/key&gt;
&lt;string&gt;App would like to access IDFA for tracking purpose.&lt;/string&gt;</code></pre></li>
<li>然后检查状态、弹出询问框的代码如下  <pre><code class="highlight objc"><span class="meta">#import <span class="string">&lt;AppTrackingTransparency/AppTrackingTransparency.h&gt;</span></span>
<span class="meta">#import <span class="string">&lt;AdSupport/AdSupport.h&gt;</span></span>
<span class="keyword">if</span> ( @available( iOS <span class="number">14</span>, * ) )
&#123;
    <span class="built_in">NSUInteger</span> status = ATTrackingManager.trackingAuthorizationStatus;
    <span class="keyword">if</span> ( status == ATTrackingManagerAuthorizationStatusNotDetermined )
    &#123;
        <span class="built_in">NSLog</span>( <span class="string">@&quot;未决定&quot;</span> );
        [ATTrackingManager requestTrackingAuthorizationWithCompletionHandler:^(ATTrackingManagerAuthorizationStatus status) &#123;
            <span class="keyword">if</span> ( status == ATTrackingManagerAuthorizationStatusAuthorized )
            &#123;
                <span class="built_in">NSLog</span> (<span class="string">@&quot;用户同意了&quot;</span>);
                <span class="built_in">NSString</span> *idfaString = [[ASIdentifierManager sharedManager] advertisingIdentifier].UUIDString;
                <span class="built_in">NSLog</span> (<span class="string">@&quot;idfaString=%@&quot;</span>, idfaString);
            &#125; <span class="keyword">else</span> &#123;
                <span class="built_in">NSLog</span> (<span class="string">@&quot;用户没同意&quot;</span>);
            &#125;
        &#125;];
    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ( status == ATTrackingManagerAuthorizationStatusRestricted )
    &#123;
        <span class="built_in">NSLog</span> (<span class="string">@&quot;限制&quot;</span>);
    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ( status == ATTrackingManagerAuthorizationStatusDenied )
    &#123;
        <span class="built_in">NSLog</span> (<span class="string">@&quot;拒绝&quot;</span>);
    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ( status == ATTrackingManagerAuthorizationStatusAuthorized )
    &#123;
        <span class="built_in">NSLog</span> (<span class="string">@&quot;同意&quot;</span>);
        <span class="built_in">NSString</span> *idfaString = [[ASIdentifierManager sharedManager] advertisingIdentifier].UUIDString;
        <span class="built_in">NSLog</span> (<span class="string">@&quot;idfaString=%@&quot;</span>, idfaString);
    &#125;
&#125; <span class="keyword">else</span> &#123;
    <span class="keyword">if</span> ( [[ASIdentifierManager sharedManager] isAdvertisingTrackingEnabled] )
    &#123;
        <span class="built_in">NSString</span> *idfaString = [[ASIdentifierManager sharedManager] advertisingIdentifier].UUIDString;
        <span class="built_in">NSLog</span>( <span class="string">@&quot;idfaString=%@&quot;</span>, idfaString );
    &#125;
&#125;</code></pre></li>
</ul>
<h1 id="可能出现的问题和解决办法"><a href="#可能出现的问题和解决办法" class="headerlink" title="可能出现的问题和解决办法"></a>可能出现的问题和解决办法</h1><ul>
<li>AppTrackingTransparency IOS14 以下崩溃<br>Xcode 导入库时候AppTrackingTransparency.framework时在 Build Phases -&gt; Link Binary With Libraries 中找到 AppTrackingTransparency.framework 状态设置为 Optional（Optional 意思为如果 IOS系统支持就会加载）。</li>
</ul>
<h1 id="参考的文章"><a href="#参考的文章" class="headerlink" title="参考的文章"></a>参考的文章</h1><p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/877101620fdb">https://www.jianshu.com/p/877101620fdb</a><br><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/1803bd950b90">https://www.jianshu.com/p/1803bd950b90</a><br><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/c80e291362be">https://www.jianshu.com/p/c80e291362be</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://615737749.github.io/2021/04/16/01Work/103_photo_module/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="porridgechen890">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="porridgechen890的笔记">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | porridgechen890的笔记">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/04/16/01Work/103_photo_module/" class="post-title-link" itemprop="url">相册模块</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-04-16 16:17:54" itemprop="dateCreated datePublished" datetime="2021-04-16T16:17:54+08:00">2021-04-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/01%E5%B7%A5%E4%BD%9C/" itemprop="url" rel="index"><span itemprop="name">01工作</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <span id="more"></span>

<h1 id="数据类的头文件"><a href="#数据类的头文件" class="headerlink" title="数据类的头文件"></a>数据类的头文件</h1><pre><code class="highlight cpp"><span class="meta">#<span class="keyword">ifndef</span> __CANDY_PHOTO_COLLECT_H__</span>
<span class="meta">#<span class="keyword">define</span> __CANDY_PHOTO_COLLECT_H__</span>

<span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span>
<span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span>
<span class="meta">#<span class="keyword">include</span> <span class="string">&lt;map&gt;</span></span>

<span class="meta">#<span class="keyword">define</span>     PHOTO_COLLECT_INVALID_PHOTO_ID 0                                        <span class="comment">//无效的photo id</span></span>
<span class="meta">#<span class="keyword">define</span>     PHOTO_COLLECT_PIECE_COUNT 16                                            <span class="comment">//一张photo有多少个piece</span></span>
<span class="meta">#<span class="keyword">define</span>     PHOTO_COLLECT_CONFIG_PATH <span class="string">&quot;config/photo_collect_config.json&quot;</span>            <span class="comment">//配置文件的路径</span></span>
<span class="meta">#<span class="keyword">define</span>     PHOTO_COLLECT_PROGRESS_FILENAME <span class="string">&quot;photo_collect_progress.json&quot;</span>           <span class="comment">//进度文件的名字，进度文件存在可读写目录下</span></span>
<span class="meta">#<span class="keyword">define</span>     PHOTO_COLLECT_ERROR_LOG cocos2d::log(<span class="string">&quot;photo_collect_error %s %s %d&quot;</span>, __FILE__, __FUNCTION__, __LINE__)      <span class="comment">//这个只是用来打印错误的函数名和行号，方便查错</span></span>

<span class="comment">//描述单张照片的结构体</span>
<span class="keyword">struct</span> <span class="title class_">StructCandyPhotoCollect</span>
&#123;
    <span class="comment">//每个photo的唯一标识，这个ID必须是正整数</span>
    <span class="type">int</span> photo_id;

    <span class="comment">//photo名</span>
    std::string name_en;
    std::string name_zh;

    <span class="comment">//说明</span>
    std::string info_en;
    std::string info_zh;

    <span class="comment">//日期</span>
    <span class="type">int</span> date_begin;
    <span class="type">int</span> date_end;
    <span class="comment">//如果一个节日有多张图，需要限制各张图在哪个关卡解锁</span>
    <span class="type">int</span> level_limit;

    <span class="comment">//关卡</span>
    <span class="type">int</span> level_begin;

    <span class="comment">//0表示没有解锁。解锁了就是大于0的数。（如2表示该图是第二顺位解锁的）</span>
    <span class="type">int</span> unlock_order;

    <span class="comment">//碎片的状态：0未获得，1获得未拼好，2获得且拼好</span>
    std::vector&lt;<span class="type">int</span>&gt; pieces_array;

    <span class="built_in">StructCandyPhotoCollect</span>()
    &#123;
        photo_id = PHOTO_COLLECT_INVALID_PHOTO_ID;  <span class="comment">//初始化为无效的photo id</span>
        date_begin = <span class="number">0</span>;  <span class="comment">//初始化为无效日期</span>
        date_end = <span class="number">0</span>;  <span class="comment">//初始化为无效日期</span>
        level_limit = <span class="number">0</span>;  <span class="comment">//初始化为无效关卡号</span>
        level_begin = <span class="number">0</span>;  <span class="comment">//初始化为无效关卡号</span>
        unlock_order = <span class="number">0</span>;  <span class="comment">//初始化为未解锁</span>
        pieces_array.<span class="built_in">resize</span>(PHOTO_COLLECT_PIECE_COUNT, <span class="number">0</span>);  <span class="comment">//初始化为所有碎片都未得到</span>
    &#125;
&#125;;

<span class="comment">// 用于管理照片收集的类</span>
<span class="keyword">class</span> <span class="title class_">CandyPhotoCollect</span>
&#123;
<span class="keyword">public</span>:
    <span class="comment">//构造函数</span>
    <span class="built_in">CandyPhotoCollect</span>();

    <span class="comment">//读配置和进度</span>
    <span class="function"><span class="type">void</span> <span class="title">of_load_data</span><span class="params">()</span></span>;

    <span class="comment">/**</span>
<span class="comment">    * 得碎片</span>
<span class="comment">    *</span>
<span class="comment">    * 如果发碎片成功，函数返回true，photo_id 和 piece_id 有值。</span>
<span class="comment">    *</span>
<span class="comment">    * @param game_model  游戏的类型，&quot;001&quot;表示主线模式，只有在主线模式下才会给玩家碎片</span>
<span class="comment">    * @param date_of_today  今天的日期，如3月2号就应该传入302</span>
<span class="comment">    * @param current_level  当前所处的关卡号</span>
<span class="comment">    * @param min_level  可以获得碎片的最小关卡号</span>
<span class="comment">    * @param photo_id 发给玩家的碎片所属的图ID</span>
<span class="comment">    * @param piece_index 发给玩家的碎片的索引，假如有16个碎片，索引就是从0到15</span>
<span class="comment">    */</span>
    <span class="function"><span class="type">bool</span> <span class="title">of_get_award_piece</span><span class="params">(<span class="type">const</span> std::string&amp; game_model, <span class="type">int</span> date_of_today, <span class="type">int</span> current_level, <span class="type">int</span> min_level, <span class="type">int</span>&amp; photo_id, <span class="type">int</span>&amp; piece_index)</span></span>;

    <span class="comment">//查：上一次得到的碎片属于哪张图，有两种情况会返回无效的photo id，(1)未解锁过任何图；(2)解锁了id为n的图，但游戏更新后，id为n的图从配置里删除了；</span>
    <span class="function"><span class="type">int</span> <span class="title">of_get_last_open_photo</span><span class="params">()</span></span>;

    <span class="comment">//查：解锁了哪些图，返回的数组是按解锁顺序排列的</span>
    <span class="function">std::vector&lt;<span class="type">int</span>&gt; <span class="title">of_get_unlock_photos</span><span class="params">()</span></span>;

    <span class="comment">//查：某一张图的所有碎片状态，返回的数组包含该图中所有碎片</span>
    <span class="function">std::vector&lt;<span class="type">int</span>&gt; <span class="title">of_get_pieces</span><span class="params">(<span class="type">int</span> photo_id)</span></span>;
    <span class="comment">//查：某一张图有多少已拼好碎片</span>
    <span class="function"><span class="type">int</span> <span class="title">of_get_photo_ok_piece_count</span><span class="params">(<span class="type">int</span> photo_id)</span></span>;

    <span class="comment">//查：某一张图的名字，需要传入语言类型</span>
    <span class="function">std::string <span class="title">of_get_name</span><span class="params">(<span class="type">int</span> photo_id, <span class="type">const</span> std::string&amp; language_type)</span></span>;
    <span class="comment">//查：某一张图的说明，需要传入语言类型</span>
    <span class="function">std::string <span class="title">of_get_introduce</span><span class="params">(<span class="type">int</span> photo_id, <span class="type">const</span> std::string&amp; language_type)</span></span>;

    <span class="comment">//改：修改某一张图的某一个碎片的状态，只有两处会调用这个方法：(1)碎片从未获得变为获得；(2)碎片从未拼好变为拼好。这两个变化都是不可逆的。</span>
    <span class="function"><span class="type">void</span> <span class="title">of_set_piece_status</span><span class="params">(<span class="type">int</span> photo_id, <span class="type">int</span> piece_id, <span class="type">int</span> piece_status)</span></span>;
    <span class="comment">//改：修改上一次获得的碎片属于哪一张图，只有一处会调用这个方法：过关后，成功找到一个碎片发给玩家</span>
    <span class="function"><span class="type">void</span> <span class="title">of_set_last_open_photo</span><span class="params">(<span class="type">int</span> photo_id)</span></span>;
<span class="keyword">private</span>:
    <span class="comment">//读配置</span>
    <span class="function"><span class="type">void</span> <span class="title">of_load_config</span><span class="params">()</span></span>;

    <span class="comment">//存文件，这个函数里有断言，如果在数据没有发生改变的时候去调用，会报错</span>
    <span class="function"><span class="type">void</span> <span class="title">of_save</span><span class="params">()</span></span>;

    <span class="comment">//查：解锁了多少张图</span>
    <span class="function"><span class="type">int</span> <span class="title">of_get_unlock_photo_count</span><span class="params">()</span></span>;

    <span class="comment">//查：某一张图有多少空闲碎片</span>
    <span class="function"><span class="type">int</span> <span class="title">of_get_photo_free_piece_count</span><span class="params">(<span class="type">int</span> photo_id)</span></span>;
    <span class="comment">//查：某一张图有多少已获得碎片</span>
    <span class="function"><span class="type">int</span> <span class="title">of_get_photo_got_piece_count</span><span class="params">(<span class="type">int</span> photo_id)</span></span>;

    <span class="comment">//查：某一张图还有哪些碎片是空闲的，返回的数组包含该图中所有空闲碎片</span>
    <span class="function">std::vector&lt;<span class="type">int</span>&gt; <span class="title">of_get_photo_free_pieces</span><span class="params">(<span class="type">int</span> photo_id)</span></span>;

    <span class="comment">//查：找出所有日期类型的配置，返回值是一个vector，内容是photo id，排在前面的是带关卡限制的日期配置，并且是按由小到大的顺序排列的</span>
    <span class="function">std::vector&lt;<span class="type">int</span>&gt; <span class="title">of_get_date_config</span><span class="params">()</span></span>;
    <span class="comment">//查：找出所有根据关卡号来解锁图片的配置，返回值是一个map，键是关卡号，值是图ID</span>
    <span class="function">std::map&lt;<span class="type">int</span>, <span class="type">int</span>&gt; <span class="title">of_get_level_config</span><span class="params">()</span></span>;

<span class="keyword">private</span>:
    <span class="comment">//上一次得到的碎片所属于的photo的id，如果没有得到过碎片，这个值是无效值</span>
    <span class="type">int</span> last_photo_id_;

    <span class="comment">//所有图片的状态</span>
    std::map&lt;<span class="type">int</span>, StructCandyPhotoCollect&gt; photos_;
&#125;;

<span class="meta">#<span class="keyword">endif</span></span>
</code></pre>

<h1 id="数据类的实现文件"><a href="#数据类的实现文件" class="headerlink" title="数据类的实现文件"></a>数据类的实现文件</h1><pre><code class="highlight cpp"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cassert&gt;</span></span>
<span class="meta">#<span class="keyword">include</span> <span class="string">&quot;cocos2d.h&quot;</span></span>
<span class="meta">#<span class="keyword">include</span> <span class="string">&quot;json/rapidjson.h&quot;</span></span>
<span class="meta">#<span class="keyword">include</span> <span class="string">&quot;json/document.h&quot;</span></span>
<span class="meta">#<span class="keyword">include</span> <span class="string">&quot;json/prettywriter.h&quot;</span></span>
<span class="meta">#<span class="keyword">include</span> <span class="string">&quot;CandyPhotoCollect.h&quot;</span></span>

CandyPhotoCollect::<span class="built_in">CandyPhotoCollect</span>()
    : <span class="built_in">last_photo_id_</span>(PHOTO_COLLECT_INVALID_PHOTO_ID)
&#123;
&#125;
<span class="function"><span class="type">void</span> <span class="title">CandyPhotoCollect::of_load_config</span><span class="params">()</span></span>
<span class="function"></span>&#123;
    photos_.<span class="built_in">clear</span>();
    std::map&lt;<span class="type">int</span>, <span class="type">int</span>&gt; map_level_config;

    std::string str_content = cocos2d::FileUtils::<span class="built_in">getInstance</span>()-&gt;<span class="built_in">getStringFromFile</span>(PHOTO_COLLECT_CONFIG_PATH);
    rapidjson::Document doc;
    doc.<span class="built_in">Parse</span>(str_content.<span class="built_in">c_str</span>());

    <span class="built_in">assert</span>(doc.<span class="built_in">HasMember</span>(<span class="string">&quot;type_date&quot;</span>));
    <span class="built_in">assert</span>(doc[<span class="string">&quot;type_date&quot;</span>].<span class="built_in">IsArray</span>());
    <span class="type">const</span> rapidjson::Value&amp; v1 = doc[<span class="string">&quot;type_date&quot;</span>].<span class="built_in">GetArray</span>();
    <span class="keyword">for</span> (rapidjson::SizeType i = <span class="number">0</span>; i &lt; v<span class="number">1.</span><span class="built_in">Size</span>(); i++)
    &#123;
        <span class="type">const</span> rapidjson::Value&amp; v_item = v1[i];
        StructCandyPhotoCollect st;
        <span class="comment">//id</span>
        <span class="built_in">assert</span>(v_item.<span class="built_in">HasMember</span>(<span class="string">&quot;id&quot;</span>));
        <span class="built_in">assert</span>(v_item[<span class="string">&quot;id&quot;</span>].<span class="built_in">IsUint</span>());
        <span class="type">int</span> photo_id = v_item[<span class="string">&quot;id&quot;</span>].<span class="built_in">GetInt</span>();
        <span class="built_in">assert</span>(photos_.<span class="built_in">find</span>(photo_id) == photos_.<span class="built_in">end</span>());
        st.photo_id = photo_id;
        <span class="comment">//英文名</span>
        <span class="built_in">assert</span>(v_item.<span class="built_in">HasMember</span>(<span class="string">&quot;name_en&quot;</span>));
        <span class="built_in">assert</span>(v_item[<span class="string">&quot;name_en&quot;</span>].<span class="built_in">IsString</span>());
        st.name_en = v_item[<span class="string">&quot;name_en&quot;</span>].<span class="built_in">GetString</span>();
        <span class="comment">//中文名</span>
        <span class="built_in">assert</span>(v_item.<span class="built_in">HasMember</span>(<span class="string">&quot;name_zh&quot;</span>));
        <span class="built_in">assert</span>(v_item[<span class="string">&quot;name_zh&quot;</span>].<span class="built_in">IsString</span>());
        st.name_zh = v_item[<span class="string">&quot;name_zh&quot;</span>].<span class="built_in">GetString</span>();
        <span class="comment">//英文说明</span>
        <span class="built_in">assert</span>(v_item.<span class="built_in">HasMember</span>(<span class="string">&quot;info_en&quot;</span>));
        <span class="built_in">assert</span>(v_item[<span class="string">&quot;info_en&quot;</span>].<span class="built_in">IsString</span>());
        st.info_en = v_item[<span class="string">&quot;info_en&quot;</span>].<span class="built_in">GetString</span>();
        <span class="comment">//中文说明</span>
        <span class="built_in">assert</span>(v_item.<span class="built_in">HasMember</span>(<span class="string">&quot;info_zh&quot;</span>));
        <span class="built_in">assert</span>(v_item[<span class="string">&quot;info_zh&quot;</span>].<span class="built_in">IsString</span>());
        st.info_zh = v_item[<span class="string">&quot;info_zh&quot;</span>].<span class="built_in">GetString</span>();
        <span class="comment">//开始日期</span>
        <span class="built_in">assert</span>(v_item.<span class="built_in">HasMember</span>(<span class="string">&quot;date_begin&quot;</span>));
        <span class="built_in">assert</span>(v_item[<span class="string">&quot;date_begin&quot;</span>].<span class="built_in">IsNumber</span>());
        st.date_begin = v_item[<span class="string">&quot;date_begin&quot;</span>].<span class="built_in">GetInt</span>();
        <span class="built_in">assert</span>(<span class="number">101</span> &lt;= st.date_begin &amp;&amp; st.date_begin &lt;= <span class="number">1231</span>);
        <span class="comment">//结束日期</span>
        <span class="built_in">assert</span>(v_item.<span class="built_in">HasMember</span>(<span class="string">&quot;date_end&quot;</span>));
        <span class="built_in">assert</span>(v_item[<span class="string">&quot;date_end&quot;</span>].<span class="built_in">IsNumber</span>());
        st.date_end = v_item[<span class="string">&quot;date_end&quot;</span>].<span class="built_in">GetInt</span>();
        <span class="built_in">assert</span>(<span class="number">101</span> &lt;= st.date_end &amp;&amp; st.date_end &lt;= <span class="number">1231</span>);
        <span class="built_in">assert</span>(st.date_end &gt;= st.date_begin);
        <span class="comment">//关卡限制</span>
        <span class="keyword">if</span> (v_item.<span class="built_in">HasMember</span>(<span class="string">&quot;level_limit&quot;</span>) &amp;&amp; v_item[<span class="string">&quot;level_limit&quot;</span>].<span class="built_in">IsNumber</span>())
        &#123;
            st.level_limit = v_item[<span class="string">&quot;level_limit&quot;</span>].<span class="built_in">GetInt</span>();
        &#125;
        <span class="comment">//不能有 level_begin</span>
        <span class="keyword">if</span> (v_item.<span class="built_in">HasMember</span>(<span class="string">&quot;level_begin&quot;</span>))
        &#123;
            <span class="built_in">assert</span>(<span class="literal">false</span>);
        &#125;
        photos_[st.photo_id] = st;
    &#125;

    <span class="built_in">assert</span>(doc.<span class="built_in">HasMember</span>(<span class="string">&quot;type_level&quot;</span>));
    <span class="built_in">assert</span>(doc[<span class="string">&quot;type_level&quot;</span>].<span class="built_in">IsArray</span>());
    <span class="type">const</span> rapidjson::Value&amp; v2 = doc[<span class="string">&quot;type_level&quot;</span>].<span class="built_in">GetArray</span>();
    <span class="keyword">for</span> (rapidjson::SizeType i = <span class="number">0</span>; i &lt; v<span class="number">2.</span><span class="built_in">Size</span>(); i++)
    &#123;
        <span class="type">const</span> rapidjson::Value&amp; v_item = v2[i];
        StructCandyPhotoCollect st;
        <span class="comment">//id</span>
        <span class="built_in">assert</span>(v_item.<span class="built_in">HasMember</span>(<span class="string">&quot;id&quot;</span>));
        <span class="built_in">assert</span>(v_item[<span class="string">&quot;id&quot;</span>].<span class="built_in">IsUint</span>());
        <span class="type">int</span> photo_id = v_item[<span class="string">&quot;id&quot;</span>].<span class="built_in">GetInt</span>();
        <span class="built_in">assert</span>(photos_.<span class="built_in">find</span>(photo_id) == photos_.<span class="built_in">end</span>());
        st.photo_id = photo_id;
        <span class="comment">//英文名</span>
        <span class="built_in">assert</span>(v_item.<span class="built_in">HasMember</span>(<span class="string">&quot;name_en&quot;</span>));
        <span class="built_in">assert</span>(v_item[<span class="string">&quot;name_en&quot;</span>].<span class="built_in">IsString</span>());
        st.name_en = v_item[<span class="string">&quot;name_en&quot;</span>].<span class="built_in">GetString</span>();
        <span class="comment">//中文名</span>
        <span class="built_in">assert</span>(v_item.<span class="built_in">HasMember</span>(<span class="string">&quot;name_zh&quot;</span>));
        <span class="built_in">assert</span>(v_item[<span class="string">&quot;name_zh&quot;</span>].<span class="built_in">IsString</span>());
        st.name_zh = v_item[<span class="string">&quot;name_zh&quot;</span>].<span class="built_in">GetString</span>();
        <span class="comment">//英文说明</span>
        <span class="built_in">assert</span>(v_item.<span class="built_in">HasMember</span>(<span class="string">&quot;info_en&quot;</span>));
        <span class="built_in">assert</span>(v_item[<span class="string">&quot;info_en&quot;</span>].<span class="built_in">IsString</span>());
        st.info_en = v_item[<span class="string">&quot;info_en&quot;</span>].<span class="built_in">GetString</span>();
        <span class="comment">//中文说明</span>
        <span class="built_in">assert</span>(v_item.<span class="built_in">HasMember</span>(<span class="string">&quot;info_zh&quot;</span>));
        <span class="built_in">assert</span>(v_item[<span class="string">&quot;info_zh&quot;</span>].<span class="built_in">IsString</span>());
        st.info_zh = v_item[<span class="string">&quot;info_zh&quot;</span>].<span class="built_in">GetString</span>();
        <span class="comment">//解锁关卡</span>
        <span class="built_in">assert</span>(v_item.<span class="built_in">HasMember</span>(<span class="string">&quot;level_begin&quot;</span>));
        <span class="built_in">assert</span>(v_item[<span class="string">&quot;level_begin&quot;</span>].<span class="built_in">IsUint</span>());
        st.level_begin = v_item[<span class="string">&quot;level_begin&quot;</span>].<span class="built_in">GetInt</span>();
        <span class="built_in">assert</span>(st.level_begin &gt; <span class="number">0</span>);
        <span class="comment">//不能有 date_begin 和 date_end</span>
        <span class="keyword">if</span> (v_item.<span class="built_in">HasMember</span>(<span class="string">&quot;date_begin&quot;</span>) || v_item.<span class="built_in">HasMember</span>(<span class="string">&quot;date_end&quot;</span>))
        &#123;
            <span class="built_in">assert</span>(<span class="literal">false</span>);
        &#125;
        <span class="comment">//存入本地变量map_level_config</span>
        <span class="built_in">assert</span>(map_level_config.<span class="built_in">find</span>(st.level_begin) == map_level_config.<span class="built_in">end</span>());
        map_level_config[st.level_begin] = st.photo_id;
        <span class="comment">//存入成员变量photos_</span>
        photos_[st.photo_id] = st;
    &#125;

    <span class="comment">//配置的图片列表肯定不为空</span>
    <span class="built_in">assert</span>(photos_.<span class="built_in">size</span>() &gt; <span class="number">0</span>);
&#125;
<span class="function">std::vector&lt;<span class="type">int</span>&gt; <span class="title">CandyPhotoCollect::of_get_date_config</span><span class="params">()</span></span>
<span class="function"></span>&#123;
    std::vector&lt;<span class="type">int</span>&gt; ret;
    std::map&lt;<span class="type">int</span>, <span class="type">int</span>&gt; m;
    std::vector&lt;<span class="type">int</span>&gt; v;
    <span class="keyword">for</span> (<span class="keyword">auto</span> i : photos_)
    &#123;
        <span class="type">int</span> date_begin = i.second.date_begin;
        <span class="keyword">if</span> (date_begin &gt; <span class="number">0</span>)
        &#123;
            <span class="type">int</span> level_limit = i.second.level_limit;
            <span class="keyword">if</span> (level_limit &gt; <span class="number">0</span>)
            &#123;
                m[level_limit] = i.first;
            &#125;
            <span class="keyword">else</span>
            &#123;
                v.<span class="built_in">push_back</span>(i.first);
            &#125;
        &#125;
    &#125;
    <span class="keyword">for</span> (<span class="keyword">auto</span> i : m)
    &#123;
        ret.<span class="built_in">push_back</span>(i.second);
    &#125;
    <span class="keyword">for</span> (<span class="keyword">auto</span> i : v)
    &#123;
        ret.<span class="built_in">push_back</span>(i);
    &#125;
    <span class="keyword">return</span> ret;
&#125;
<span class="function">std::map&lt;<span class="type">int</span>, <span class="type">int</span>&gt; <span class="title">CandyPhotoCollect::of_get_level_config</span><span class="params">()</span></span>
<span class="function"></span>&#123;
    std::map&lt;<span class="type">int</span>, <span class="type">int</span>&gt; ret;
    <span class="keyword">for</span> (<span class="keyword">auto</span> i : photos_)
    &#123;
        <span class="type">int</span> level_begin = i.second.level_begin;
        <span class="keyword">if</span> (level_begin &gt; <span class="number">0</span>)
        &#123;
            ret[level_begin] = i.first;
        &#125;
    &#125;
    <span class="keyword">return</span> ret;
&#125;
<span class="function"><span class="type">void</span> <span class="title">CandyPhotoCollect::of_load_data</span><span class="params">()</span></span>
<span class="function"></span>&#123;
    <span class="built_in">of_load_config</span>();

    std::string str_progress_file_path = cocos2d::FileUtils::<span class="built_in">getInstance</span>()-&gt;<span class="built_in">getWritablePath</span>() + PHOTO_COLLECT_PROGRESS_FILENAME;
    std::string str_content = cocos2d::FileUtils::<span class="built_in">getInstance</span>()-&gt;<span class="built_in">getStringFromFile</span>(str_progress_file_path);
    <span class="keyword">if</span> (str_content.<span class="built_in">empty</span>())
    &#123;
        <span class="comment">//这里返回就代表没有读进度。此时last_photo_id_的值等于PHOTO_COLLECT_INVALID_PHOTO_ID</span>
        <span class="keyword">return</span>;
    &#125;

    rapidjson::Document doc;
    doc.<span class="built_in">Parse</span>(str_content.<span class="built_in">c_str</span>());

    <span class="comment">//1. 读解锁顺序。注意：进度里存的值不都是有效的，（假如进度中存的是：&quot;unlock_order&quot;:[19,11,33]，但更新游戏后id为11的图被删掉了，那么11那个值就没用了，会跳过）</span>
    <span class="keyword">if</span> (doc.<span class="built_in">HasMember</span>(<span class="string">&quot;unlock_order&quot;</span>) &amp;&amp; doc[<span class="string">&quot;unlock_order&quot;</span>].<span class="built_in">IsArray</span>())
    &#123;
        <span class="type">int</span> unlock_index = <span class="number">1</span>;
        <span class="type">const</span> rapidjson::Value&amp; rjv_unlock_order = doc[<span class="string">&quot;unlock_order&quot;</span>].<span class="built_in">GetArray</span>();
        <span class="keyword">for</span> (rapidjson::SizeType i = <span class="number">0</span>; i &lt; rjv_unlock_order.<span class="built_in">Size</span>(); i++)
        &#123;
            <span class="type">const</span> rapidjson::Value&amp; rjv_item = rjv_unlock_order[i];
            <span class="keyword">if</span> (rjv_item.<span class="built_in">IsUint</span>())
            &#123;
                <span class="type">int</span> photo_id = rjv_item.<span class="built_in">GetInt</span>();
                <span class="keyword">if</span> (photos_.<span class="built_in">find</span>(photo_id) == photos_.<span class="built_in">end</span>())
                &#123;
                    <span class="keyword">continue</span>;
                &#125;
                photos_[photo_id].unlock_order = unlock_index;
                unlock_index++;
            &#125;
        &#125;
    &#125;

    <span class="comment">//2. 读最近解锁的哪张图</span>
    <span class="keyword">if</span> (doc.<span class="built_in">HasMember</span>(<span class="string">&quot;last_piece_belong_to_which_photo&quot;</span>) &amp;&amp; doc[<span class="string">&quot;last_piece_belong_to_which_photo&quot;</span>].<span class="built_in">IsUint</span>())
    &#123;
        <span class="type">int</span> last_photo_id = doc[<span class="string">&quot;last_piece_belong_to_which_photo&quot;</span>].<span class="built_in">GetInt</span>();
        <span class="keyword">if</span> (photos_.<span class="built_in">find</span>(last_photo_id) != photos_.<span class="built_in">end</span>())
        &#123;
            last_photo_id_ = last_photo_id;
        &#125;
    &#125;

    <span class="comment">//3. 读每张图的碎片状态</span>
    <span class="keyword">for</span> (<span class="keyword">auto</span> i : photos_)
    &#123;
        <span class="type">int</span> photo_id = i.first;
        std::string str_key_pieces = <span class="string">&quot;photo_&quot;</span> + std::<span class="built_in">to_string</span>(photo_id) + <span class="string">&quot;_pieces&quot;</span>;
        <span class="keyword">if</span> (doc.<span class="built_in">HasMember</span>(str_key_pieces.<span class="built_in">c_str</span>()) == <span class="literal">false</span>)
        &#123;
            <span class="comment">//说明更新游戏后，新增了图，进度里是没有这张图的。</span>
            <span class="keyword">continue</span>;
        &#125;
        <span class="keyword">if</span> (doc[str_key_pieces.<span class="built_in">c_str</span>()].<span class="built_in">IsArray</span>())
        &#123;
            <span class="type">const</span> rapidjson::Value&amp; rjv_pieces_status = doc[str_key_pieces.<span class="built_in">c_str</span>()].<span class="built_in">GetArray</span>();
            <span class="keyword">if</span> (rjv_pieces_status.<span class="built_in">Size</span>() == PHOTO_COLLECT_PIECE_COUNT)
            &#123;
                <span class="keyword">for</span> (rapidjson::SizeType j = <span class="number">0</span>; j &lt; rjv_pieces_status.<span class="built_in">Size</span>(); j++)
                &#123;
                    <span class="type">const</span> rapidjson::Value&amp; rjv_item = rjv_pieces_status[j];
                    <span class="keyword">if</span> (rjv_item.<span class="built_in">IsInt</span>())
                    &#123;
                        <span class="type">int</span> piece_status = rjv_item.<span class="built_in">GetInt</span>();
                        <span class="keyword">if</span> (piece_status == <span class="number">0</span> || piece_status == <span class="number">1</span> || piece_status == <span class="number">2</span>)
                        &#123;
                            photos_[photo_id].pieces_array[j] = piece_status;<span class="comment">//把碎片的状态从文件里写进内存里</span>
                        &#125;
                    &#125;
                &#125;
            &#125;
        &#125;
    &#125;

    <span class="comment">//校验，如果last photo id是一个有效值的话，那么它对应的photo的unlock order肯定是大于0的，即肯定是解锁了的。</span>
    <span class="keyword">if</span> (PHOTO_COLLECT_INVALID_PHOTO_ID != last_photo_id_)
    &#123;
        <span class="keyword">if</span> (photos_[last_photo_id_].unlock_order &lt;= <span class="number">0</span>)
        &#123;
            PHOTO_COLLECT_ERROR_LOG;
            last_photo_id_ = PHOTO_COLLECT_INVALID_PHOTO_ID;
        &#125;
    &#125;
    <span class="comment">//校验unlcok order的值和pieces array的值是否匹配，如果解锁顺序大于0，那么碎片数组里肯定有状态大于0的碎片</span>
    <span class="keyword">for</span> (<span class="keyword">auto</span>&amp; i : photos_)
    &#123;
        <span class="keyword">if</span> (i.second.unlock_order &gt; <span class="number">0</span>)
        &#123;
            <span class="type">bool</span> b = <span class="literal">false</span>;
            <span class="keyword">for</span> (<span class="type">size_t</span> j = <span class="number">0</span>; j &lt; i.second.pieces_array.<span class="built_in">size</span>(); ++j)
            &#123;
                <span class="keyword">if</span> (i.second.pieces_array.<span class="built_in">at</span>(j) &gt; <span class="number">0</span>)
                &#123;
                    b = <span class="literal">true</span>;
                    <span class="keyword">break</span>;
                &#125;
            &#125;
            <span class="keyword">if</span> (!b)
            &#123;
                PHOTO_COLLECT_ERROR_LOG;
                i.second.unlock_order = <span class="number">0</span>;
            &#125;
        &#125;
    &#125;
&#125;
<span class="function"><span class="type">void</span> <span class="title">CandyPhotoCollect::of_save</span><span class="params">()</span></span>
<span class="function"></span>&#123;
    <span class="keyword">if</span> (photos_.<span class="built_in">find</span>(last_photo_id_) == photos_.<span class="built_in">end</span>())
    &#123;
        PHOTO_COLLECT_ERROR_LOG;
        <span class="keyword">return</span>;
    &#125;

    <span class="function">rapidjson::Document <span class="title">writedoc</span><span class="params">(rapidjson::kObjectType)</span></span>;
    rapidjson::Document::AllocatorType&amp; allocator = writedoc.<span class="built_in">GetAllocator</span>();

    <span class="comment">//1.存最近一次得到的碎片属于哪张图</span>
    &#123;
        rapidjson::Value rjv_last_photo_id;
        rjv_last_photo_id.<span class="built_in">SetInt</span>(last_photo_id_);
        writedoc.<span class="built_in">AddMember</span>(<span class="string">&quot;last_piece_belong_to_which_photo&quot;</span>, rjv_last_photo_id, allocator);
    &#125;

    <span class="comment">//2.按先后顺序存解锁了的图</span>
    &#123;
        <span class="comment">//这个数组用来存所有的解锁顺序，用来验证解锁顺序是不是从1开始递增的</span>
        std::vector&lt;<span class="type">int</span>&gt; vec_unlock_order;
        <span class="keyword">for</span> (<span class="keyword">auto</span>&amp; i : photos_)
        &#123;
            <span class="type">bool</span> b_unlock = <span class="literal">false</span>;
            <span class="keyword">for</span> (<span class="type">size_t</span> j = <span class="number">0</span>; j &lt; i.second.pieces_array.<span class="built_in">size</span>(); ++j)
            &#123;
                <span class="keyword">if</span> (i.second.pieces_array.<span class="built_in">at</span>(j) &gt; <span class="number">0</span>)
                &#123;
                    b_unlock = <span class="literal">true</span>;
                    <span class="keyword">break</span>;
                &#125;
            &#125;
            <span class="keyword">if</span> (b_unlock)
            &#123;
                <span class="type">int</span> unlock_order = i.second.unlock_order;
                <span class="keyword">if</span> (unlock_order &lt;= <span class="number">0</span>)
                &#123;
                    PHOTO_COLLECT_ERROR_LOG;
                    <span class="keyword">return</span>;
                &#125;
                <span class="keyword">else</span>
                &#123;
                    vec_unlock_order.<span class="built_in">push_back</span>(unlock_order);
                &#125;
            &#125;
        &#125;
        std::<span class="built_in">sort</span>(vec_unlock_order.<span class="built_in">begin</span>(), vec_unlock_order.<span class="built_in">end</span>());
        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; vec_unlock_order.<span class="built_in">size</span>(); ++i)
        &#123;
            <span class="keyword">if</span> (vec_unlock_order[i] != i + <span class="number">1</span>)
            &#123;
                PHOTO_COLLECT_ERROR_LOG;
                <span class="keyword">return</span>;
            &#125;
        &#125;
        <span class="comment">//执行到这里说明验证通过，接下来用一个map把所有解锁的图，按解锁的先后顺序存起来</span>
        std::map&lt;<span class="type">int</span>, <span class="type">int</span>&gt; map_unlock_order;
        <span class="keyword">for</span> (<span class="keyword">auto</span> i : photos_)
        &#123;
            <span class="type">int</span> photo_id = i.first;
            <span class="type">int</span> unlock_order = i.second.unlock_order;
            <span class="keyword">if</span> (unlock_order &gt; <span class="number">0</span>)
            &#123;
                map_unlock_order[unlock_order] = photo_id;
            &#125;
        &#125;
        <span class="comment">//根据刚才得到的map，把所有解锁了的图的id，按先后顺序写入文件</span>
        <span class="function">rapidjson::Value <span class="title">rjv</span><span class="params">(rapidjson::kArrayType)</span></span>;
        <span class="keyword">for</span> (<span class="keyword">auto</span> i : map_unlock_order)
        &#123;
            rjv.<span class="built_in">PushBack</span>(i.second, allocator);
        &#125;
        writedoc.<span class="built_in">AddMember</span>(<span class="string">&quot;unlock_order&quot;</span>, rjv, allocator);
    &#125;

    <span class="comment">//3.存碎片状态</span>
    &#123;
        <span class="keyword">for</span> (<span class="keyword">auto</span> i : photos_)
        &#123;
            <span class="type">int</span> photo_id = i.first;
            std::string str_key = <span class="string">&quot;photo_&quot;</span> + std::<span class="built_in">to_string</span>(photo_id) + <span class="string">&quot;_pieces&quot;</span>;
            rapidjson::Value rjv1;
            rjv<span class="number">1.</span><span class="built_in">SetString</span>(str_key.<span class="built_in">c_str</span>(), <span class="built_in">int</span>(str_key.<span class="built_in">size</span>()), allocator);

            <span class="function">rapidjson::Value <span class="title">rjv2</span><span class="params">(rapidjson::kArrayType)</span></span>;
            <span class="keyword">for</span> (<span class="keyword">auto</span> j : i.second.pieces_array)
            &#123;
                <span class="keyword">if</span> (j != <span class="number">0</span> &amp;&amp; j != <span class="number">1</span> &amp;&amp; j != <span class="number">2</span>)
                &#123;
                    PHOTO_COLLECT_ERROR_LOG;
                    <span class="keyword">return</span>;
                &#125;
                rjv<span class="number">2.</span><span class="built_in">PushBack</span>(j, allocator);
            &#125;
            writedoc.<span class="built_in">AddMember</span>(rjv1, rjv2, allocator);
        &#125;
    &#125;

    rapidjson::StringBuffer jsonBuffer;
    <span class="function">rapidjson::PrettyWriter&lt;rapidjson::StringBuffer&gt; <span class="title">jsonWriter</span><span class="params">(jsonBuffer)</span></span>;
    writedoc.<span class="built_in">Accept</span>(jsonWriter);

    std::string str_going_to_write = jsonBuffer.<span class="built_in">GetString</span>();
    std::string str_progress_path = cocos2d::FileUtils::<span class="built_in">getInstance</span>()-&gt;<span class="built_in">getWritablePath</span>() + PHOTO_COLLECT_PROGRESS_FILENAME;
    cocos2d::FileUtils::<span class="built_in">getInstance</span>()-&gt;<span class="built_in">writeStringToFile</span>(str_going_to_write, str_progress_path);
&#125;
<span class="function"><span class="type">bool</span> <span class="title">CandyPhotoCollect::of_get_award_piece</span><span class="params">(<span class="type">const</span> std::string&amp; game_model, <span class="type">int</span> date_of_today, <span class="type">int</span> current_level, <span class="type">int</span> min_level, <span class="type">int</span>&amp; photo_id, <span class="type">int</span>&amp; piece_index)</span></span>
<span class="function"></span>&#123;
    photo_id = <span class="number">0</span>;
    piece_index = <span class="number">0</span>;

    <span class="comment">//不是主线关卡不给碎片</span>
    <span class="keyword">if</span> (game_model != <span class="string">&quot;001&quot;</span>)
    &#123;
        <span class="keyword">return</span> <span class="literal">false</span>;
    &#125;

    <span class="comment">//如果当前关卡小于“最小的给碎片关卡”，就返回false</span>
    <span class="keyword">if</span> (current_level &lt; min_level)
    &#123;
        <span class="keyword">return</span> <span class="literal">false</span>;
    &#125;

    <span class="comment">//“最近获得的碎片的图ID”等于“无效图ID”有两种情况：1.从来没有得到过碎片；2.以前得到过某张图的碎片，后来更新游戏后，这张图对应的ID被删掉了</span>
    <span class="keyword">if</span> (PHOTO_COLLECT_INVALID_PHOTO_ID == last_photo_id_)
    &#123;
        <span class="comment">//匹配日期的图</span>
        <span class="keyword">for</span> (<span class="keyword">auto</span> id : <span class="built_in">of_get_date_config</span>())
        &#123;
            <span class="comment">//日期过滤一次</span>
            <span class="keyword">if</span> (date_of_today &lt; photos_[id].date_begin || date_of_today &gt; photos_[id].date_end) <span class="keyword">continue</span>;

            <span class="comment">//如果带关卡号限制，再用关卡号限制过滤一次</span>
            <span class="keyword">if</span> (<span class="number">0</span> != photos_[id].level_limit &amp;&amp; photos_[id].level_limit &gt; current_level) <span class="keyword">continue</span>;

            <span class="comment">//判断该图是不是还一个碎片都没发出去，再过滤一次</span>
            <span class="keyword">if</span> (<span class="built_in">of_get_photo_free_piece_count</span>(id) != PHOTO_COLLECT_PIECE_COUNT) <span class="keyword">continue</span>;

            <span class="comment">//执行到这里说明找到了满足条件的图，修改返回值</span>
            photo_id = id;
            piece_index = <span class="built_in">rand</span>() % PHOTO_COLLECT_PIECE_COUNT;

            <span class="comment">//修改内部变量并存盘</span>
            last_photo_id_ = photo_id;
            photos_[photo_id].unlock_order = <span class="number">1</span> + <span class="built_in">of_get_unlock_photo_count</span>();
            photos_[photo_id].pieces_array[piece_index] = <span class="number">1</span>;
            <span class="built_in">of_save</span>();
            <span class="keyword">return</span> <span class="literal">true</span>;
        &#125;
        <span class="comment">//匹配关卡的图</span>
        <span class="keyword">for</span> (<span class="keyword">auto</span> i : <span class="built_in">of_get_level_config</span>())
        &#123;
            <span class="comment">//如果当前关卡小于解锁关卡，跳过</span>
            <span class="keyword">if</span> (current_level &lt; i.first) <span class="keyword">continue</span>;

            <span class="keyword">if</span> (<span class="built_in">of_get_photo_free_piece_count</span>(i.second) != PHOTO_COLLECT_PIECE_COUNT) <span class="keyword">continue</span>;

            photo_id = i.second;
            piece_index = <span class="built_in">rand</span>() % PHOTO_COLLECT_PIECE_COUNT;

            last_photo_id_ = photo_id;
            photos_[photo_id].unlock_order = <span class="number">1</span> + <span class="built_in">of_get_unlock_photo_count</span>();
            photos_[photo_id].pieces_array[piece_index] = <span class="number">1</span>;
            <span class="built_in">of_save</span>();
            <span class="keyword">return</span> <span class="literal">true</span>;
        &#125;
        <span class="comment">//没匹配上</span>
        <span class="keyword">return</span> <span class="literal">false</span>;
    &#125;

    <span class="comment">//执行到这里说明last_photo_id_不等于PHOTO_COLLECT_INVALID_PHOTO_ID，校验一下这个值是否合法，要是不合法，就跳过</span>
    <span class="keyword">if</span> (photos_.<span class="built_in">find</span>(last_photo_id_) == photos_.<span class="built_in">end</span>())
    &#123;
        last_photo_id_ = PHOTO_COLLECT_INVALID_PHOTO_ID;<span class="comment">//把这个值赋值成初始化的状态，不然永远都发不出碎片了</span>
        <span class="keyword">return</span> <span class="literal">false</span>;
    &#125;

    <span class="comment">//统计一下last photo已获得的碎片个数，如果个数小于PHOTO_COLLECT_PIECE_COUNT，那就发这个图的碎片出去</span>
    <span class="keyword">if</span> (<span class="built_in">of_get_photo_got_piece_count</span>(last_photo_id_) &lt; PHOTO_COLLECT_PIECE_COUNT)
    &#123;
        <span class="comment">//把该图中所有状态为 未发出 的碎片找出来，把它们的索引存进一个 vector 里</span>
        <span class="keyword">auto</span> available_pieces = <span class="built_in">of_get_photo_free_pieces</span>(last_photo_id_);
        <span class="comment">//随机一个碎片发出去</span>
        <span class="type">int</span> len = available_pieces.<span class="built_in">size</span>();
        <span class="type">int</span> idx = <span class="built_in">rand</span>() % len;
        photo_id = last_photo_id_;
        piece_index = available_pieces.<span class="built_in">at</span>(idx);
        photos_[photo_id].pieces_array[piece_index] = <span class="number">1</span>;
        <span class="comment">//此时last_photo_id_和photos_[photo_id].unlock_order并没有发生变化</span>
        <span class="built_in">of_save</span>();
        <span class="keyword">return</span> <span class="literal">true</span>;
    &#125;

    <span class="comment">//执行到这里说明，last_photo_id_的碎片发完了，要新开一张图</span>
    <span class="keyword">for</span> (<span class="keyword">auto</span> id : <span class="built_in">of_get_date_config</span>())
    &#123;
        <span class="keyword">auto</span> available_pieces = <span class="built_in">of_get_photo_free_pieces</span>(id);
        <span class="keyword">if</span> (available_pieces.<span class="built_in">size</span>() &lt;= <span class="number">0</span>) <span class="keyword">continue</span>;

        <span class="type">bool</span> b1 = photos_[id].date_begin &lt;= date_of_today &amp;&amp; date_of_today &lt;= photos_[id].date_end;<span class="comment">//日期是否匹配</span>
        <span class="keyword">if</span> (!b1) <span class="keyword">continue</span>;

        <span class="keyword">if</span> (<span class="number">0</span> != photos_[id].level_limit &amp;&amp; current_level &lt; photos_[id].level_limit) <span class="keyword">continue</span>;

        <span class="type">int</span> len = available_pieces.<span class="built_in">size</span>();
        <span class="type">int</span> idx = <span class="built_in">rand</span>() % len;
        photo_id = id;
        piece_index = available_pieces.<span class="built_in">at</span>(idx);

        photos_[photo_id].unlock_order = <span class="number">1</span> + <span class="built_in">of_get_unlock_photo_count</span>();
        last_photo_id_ = photo_id;
        photos_[photo_id].pieces_array[piece_index] = <span class="number">1</span>;
        <span class="built_in">of_save</span>();
        <span class="keyword">return</span> <span class="literal">true</span>;
    &#125;

    <span class="comment">//执行到这里说明想要开一张日期匹配的图没找到，那就找一下关卡匹配的图</span>
    <span class="keyword">for</span> (<span class="keyword">auto</span> i : <span class="built_in">of_get_level_config</span>())
    &#123;
        <span class="keyword">if</span> (current_level &lt; i.first) <span class="keyword">continue</span>;
        <span class="type">int</span> li_photo_id = i.second;
        <span class="keyword">auto</span> available_pieces = <span class="built_in">of_get_photo_free_pieces</span>(li_photo_id);
        <span class="keyword">if</span> (available_pieces.<span class="built_in">size</span>() &lt;= <span class="number">0</span>) <span class="keyword">continue</span>;

        <span class="type">int</span> len = available_pieces.<span class="built_in">size</span>();
        <span class="type">int</span> idx = <span class="built_in">rand</span>() % len;
        photo_id = li_photo_id;
        piece_index = available_pieces.<span class="built_in">at</span>(idx);
        photos_[photo_id].unlock_order = <span class="number">1</span> + <span class="built_in">of_get_unlock_photo_count</span>();
        last_photo_id_ = photo_id;
        photos_[photo_id].pieces_array[piece_index] = <span class="number">1</span>;
        <span class="built_in">of_save</span>();
        <span class="keyword">return</span> <span class="literal">true</span>;
    &#125;

    <span class="keyword">return</span> <span class="literal">false</span>;
&#125;

<span class="function"><span class="type">int</span> <span class="title">CandyPhotoCollect::of_get_last_open_photo</span><span class="params">()</span></span>
<span class="function"></span>&#123;
    <span class="keyword">if</span> (photos_.<span class="built_in">size</span>() &lt;= <span class="number">0</span>)
    &#123;
        PHOTO_COLLECT_ERROR_LOG;
        <span class="keyword">return</span> PHOTO_COLLECT_INVALID_PHOTO_ID;
    &#125;
    <span class="keyword">if</span> (photos_.<span class="built_in">find</span>(last_photo_id_) == photos_.<span class="built_in">end</span>())
    &#123;
        PHOTO_COLLECT_ERROR_LOG;
        <span class="keyword">return</span> PHOTO_COLLECT_INVALID_PHOTO_ID;
    &#125;
    <span class="keyword">return</span> last_photo_id_;
&#125;
<span class="function"><span class="type">void</span> <span class="title">CandyPhotoCollect::of_set_last_open_photo</span><span class="params">(<span class="type">int</span> photo_id)</span></span>
<span class="function"></span>&#123;
    <span class="keyword">if</span> (photos_.<span class="built_in">size</span>() &lt;= <span class="number">0</span>)
    &#123;
        PHOTO_COLLECT_ERROR_LOG;
        <span class="keyword">return</span>;
    &#125;
    <span class="keyword">if</span> (photos_.<span class="built_in">find</span>(photo_id) == photos_.<span class="built_in">end</span>())
    &#123;
        PHOTO_COLLECT_ERROR_LOG;
        <span class="keyword">return</span>;
    &#125;

    last_photo_id_ = photo_id;
    <span class="built_in">of_save</span>();
&#125;

<span class="function"><span class="type">int</span> <span class="title">CandyPhotoCollect::of_get_unlock_photo_count</span><span class="params">()</span></span>
<span class="function"></span>&#123;
    <span class="keyword">if</span> (photos_.<span class="built_in">size</span>() &lt;= <span class="number">0</span>)
    &#123;
        PHOTO_COLLECT_ERROR_LOG;
        <span class="keyword">return</span> <span class="number">0</span>;
    &#125;

    <span class="type">int</span> cnt = <span class="number">0</span>;
    <span class="keyword">for</span> (<span class="keyword">auto</span> i : photos_)
    &#123;
        <span class="keyword">for</span> (<span class="keyword">auto</span> j : i.second.pieces_array)
        &#123;
            <span class="keyword">if</span> (j &gt; <span class="number">0</span>)
            &#123;
                cnt++;
                <span class="keyword">break</span>;
            &#125;
        &#125;
    &#125;
    <span class="keyword">return</span> cnt;
&#125;
<span class="function">std::vector&lt;<span class="type">int</span>&gt; <span class="title">CandyPhotoCollect::of_get_unlock_photos</span><span class="params">()</span></span>
<span class="function"></span>&#123;
    std::vector&lt;<span class="type">int</span>&gt; ret;
    <span class="type">int</span> cnt = <span class="number">1</span>;
    <span class="type">bool</span> flag = <span class="literal">false</span>;
    <span class="keyword">do</span>
    &#123;
        flag = <span class="literal">false</span>;
        <span class="keyword">for</span> (<span class="keyword">auto</span> i : photos_)
        &#123;
            <span class="keyword">if</span> (i.second.unlock_order == cnt)
            &#123;
                flag = <span class="literal">true</span>;
                ret.<span class="built_in">push_back</span>(i.first);
                cnt++;
                <span class="keyword">break</span>;
            &#125;
        &#125;
    &#125; <span class="keyword">while</span> (flag);
    <span class="keyword">return</span> ret;
&#125;

<span class="function">std::vector&lt;<span class="type">int</span>&gt; <span class="title">CandyPhotoCollect::of_get_pieces</span><span class="params">(<span class="type">int</span> photo_id)</span></span>
<span class="function"></span>&#123;
    <span class="keyword">if</span> (photos_.<span class="built_in">size</span>() &lt;= <span class="number">0</span>)
    &#123;
        PHOTO_COLLECT_ERROR_LOG;
        <span class="keyword">return</span> std::<span class="built_in">vector</span>&lt;<span class="type">int</span>&gt;();
    &#125;
    <span class="keyword">if</span> (photos_.<span class="built_in">find</span>(photo_id) == photos_.<span class="built_in">end</span>())
    &#123;
        PHOTO_COLLECT_ERROR_LOG;
        <span class="keyword">return</span> std::<span class="built_in">vector</span>&lt;<span class="type">int</span>&gt;();
    &#125;

    <span class="keyword">return</span> photos_[photo_id].pieces_array;
&#125;
<span class="function">std::vector&lt;<span class="type">int</span>&gt; <span class="title">CandyPhotoCollect::of_get_photo_free_pieces</span><span class="params">(<span class="type">int</span> photo_id)</span></span>
<span class="function"></span>&#123;
    <span class="keyword">if</span> (photos_.<span class="built_in">size</span>() &lt;= <span class="number">0</span>)
    &#123;
        PHOTO_COLLECT_ERROR_LOG;
        <span class="keyword">return</span> std::<span class="built_in">vector</span>&lt;<span class="type">int</span>&gt;();
    &#125;
    <span class="keyword">if</span> (photos_.<span class="built_in">find</span>(photo_id) == photos_.<span class="built_in">end</span>())
    &#123;
        PHOTO_COLLECT_ERROR_LOG;
        <span class="keyword">return</span> std::<span class="built_in">vector</span>&lt;<span class="type">int</span>&gt;();
    &#125;
    <span class="keyword">if</span> (photos_[photo_id].pieces_array.<span class="built_in">size</span>() != PHOTO_COLLECT_PIECE_COUNT)
    &#123;
        PHOTO_COLLECT_ERROR_LOG;
        <span class="keyword">return</span> std::<span class="built_in">vector</span>&lt;<span class="type">int</span>&gt;();
    &#125;

    std::vector&lt;<span class="type">int</span>&gt; available_pieces;
    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; PHOTO_COLLECT_PIECE_COUNT; ++i)
    &#123;
        <span class="keyword">if</span> (photos_[photo_id].pieces_array[i] == <span class="number">0</span>)
        &#123;
            available_pieces.<span class="built_in">push_back</span>(i);
        &#125;
    &#125;
    <span class="keyword">return</span> available_pieces;
&#125;
<span class="function"><span class="type">int</span> <span class="title">CandyPhotoCollect::of_get_photo_free_piece_count</span><span class="params">(<span class="type">int</span> photo_id)</span></span>
<span class="function"></span>&#123;
    <span class="keyword">if</span> (photos_.<span class="built_in">size</span>() &lt;= <span class="number">0</span>)
    &#123;
        PHOTO_COLLECT_ERROR_LOG;
        <span class="keyword">return</span> <span class="number">0</span>;
    &#125;
    <span class="keyword">if</span> (photos_.<span class="built_in">find</span>(photo_id) == photos_.<span class="built_in">end</span>())
    &#123;
        PHOTO_COLLECT_ERROR_LOG;
        <span class="keyword">return</span> <span class="number">0</span>;
    &#125;

    <span class="type">int</span> cnt = <span class="number">0</span>;
    <span class="keyword">for</span> (<span class="keyword">auto</span> status : photos_[photo_id].pieces_array)
    &#123;
        <span class="keyword">if</span> (status == <span class="number">0</span>)
        &#123;
            cnt++;
        &#125;
    &#125;
    <span class="keyword">return</span> cnt;
&#125;
<span class="function"><span class="type">int</span> <span class="title">CandyPhotoCollect::of_get_photo_got_piece_count</span><span class="params">(<span class="type">int</span> photo_id)</span></span>
<span class="function"></span>&#123;
    <span class="keyword">if</span> (photos_.<span class="built_in">size</span>() &lt;= <span class="number">0</span>)
    &#123;
        PHOTO_COLLECT_ERROR_LOG;
        <span class="keyword">return</span> <span class="number">0</span>;
    &#125;
    <span class="keyword">if</span> (photos_.<span class="built_in">find</span>(photo_id) == photos_.<span class="built_in">end</span>())
    &#123;
        PHOTO_COLLECT_ERROR_LOG;
        <span class="keyword">return</span> <span class="number">0</span>;
    &#125;

    <span class="type">int</span> cnt = <span class="number">0</span>;
    <span class="keyword">for</span> (<span class="keyword">auto</span> status : photos_[photo_id].pieces_array)
    &#123;
        <span class="keyword">if</span> (status &gt;= <span class="number">1</span>)
        &#123;
            cnt++;
        &#125;
    &#125;
    <span class="keyword">return</span> cnt;
&#125;
<span class="function"><span class="type">int</span> <span class="title">CandyPhotoCollect::of_get_photo_ok_piece_count</span><span class="params">(<span class="type">int</span> photo_id)</span></span>
<span class="function"></span>&#123;
    <span class="keyword">if</span> (photos_.<span class="built_in">size</span>() &lt;= <span class="number">0</span>)
    &#123;
        PHOTO_COLLECT_ERROR_LOG;
        <span class="keyword">return</span> <span class="number">0</span>;
    &#125;
    <span class="keyword">if</span> (photos_.<span class="built_in">find</span>(photo_id) == photos_.<span class="built_in">end</span>())
    &#123;
        PHOTO_COLLECT_ERROR_LOG;
        <span class="keyword">return</span> <span class="number">0</span>;
    &#125;

    <span class="type">int</span> cnt = <span class="number">0</span>;
    <span class="keyword">for</span> (<span class="keyword">auto</span> status : photos_[photo_id].pieces_array)
    &#123;
        <span class="keyword">if</span> (status == <span class="number">2</span>)
        &#123;
            cnt++;
        &#125;
    &#125;
    <span class="keyword">return</span> cnt;
&#125;
<span class="function"><span class="type">void</span> <span class="title">CandyPhotoCollect::of_set_piece_status</span><span class="params">(<span class="type">int</span> photo_id, <span class="type">int</span> piece_id, <span class="type">int</span> piece_status)</span></span>
<span class="function"></span>&#123;
    <span class="keyword">if</span> (photos_.<span class="built_in">size</span>() &lt;= <span class="number">0</span>)
    &#123;
        PHOTO_COLLECT_ERROR_LOG;
        <span class="keyword">return</span>;
    &#125;
    <span class="keyword">if</span> (photos_.<span class="built_in">find</span>(photo_id) == photos_.<span class="built_in">end</span>())
    &#123;
        PHOTO_COLLECT_ERROR_LOG;
        <span class="keyword">return</span>;
    &#125;
    <span class="keyword">if</span> (piece_id &lt; <span class="number">0</span> || piece_id &gt;= PHOTO_COLLECT_PIECE_COUNT)
    &#123;
        PHOTO_COLLECT_ERROR_LOG;
        <span class="keyword">return</span>;
    &#125;
    <span class="keyword">if</span> (piece_status != <span class="number">0</span> &amp;&amp; piece_status != <span class="number">1</span> &amp;&amp; piece_status != <span class="number">2</span>)
    &#123;
        PHOTO_COLLECT_ERROR_LOG;
        <span class="keyword">return</span>;
    &#125;

    <span class="comment">//修改内存中的值</span>
    photos_[photo_id].pieces_array[piece_id] = piece_status;

    <span class="comment">//修改文件中的值</span>
    <span class="built_in">of_save</span>();
&#125;

<span class="function">std::string <span class="title">CandyPhotoCollect::of_get_name</span><span class="params">(<span class="type">int</span> photo_id, <span class="type">const</span> std::string &amp; language_type)</span></span>
<span class="function"></span>&#123;
    <span class="keyword">if</span> (photos_.<span class="built_in">size</span>() &lt;= <span class="number">0</span>)
    &#123;
        PHOTO_COLLECT_ERROR_LOG;
        <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;
    &#125;
    <span class="keyword">if</span> (photos_.<span class="built_in">find</span>(photo_id) == photos_.<span class="built_in">end</span>())
    &#123;
        PHOTO_COLLECT_ERROR_LOG;
        <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;
    &#125;

    <span class="keyword">if</span> (language_type == <span class="string">&quot;zh&quot;</span>)
    &#123;
        <span class="keyword">return</span> photos_[photo_id].name_zh;
    &#125;
    <span class="keyword">return</span> photos_[photo_id].name_en;
&#125;
<span class="function">std::string <span class="title">CandyPhotoCollect::of_get_introduce</span><span class="params">(<span class="type">int</span> photo_id, <span class="type">const</span> std::string &amp; language_type)</span></span>
<span class="function"></span>&#123;
    <span class="keyword">if</span> (photos_.<span class="built_in">size</span>() &lt;= <span class="number">0</span>)
    &#123;
        PHOTO_COLLECT_ERROR_LOG;
        <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;
    &#125;
    <span class="keyword">if</span> (photos_.<span class="built_in">find</span>(photo_id) == photos_.<span class="built_in">end</span>())
    &#123;
        PHOTO_COLLECT_ERROR_LOG;
        <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;
    &#125;

    <span class="keyword">if</span> (language_type == <span class="string">&quot;zh&quot;</span>)
    &#123;
        <span class="keyword">return</span> photos_[photo_id].info_zh;
    &#125;
    <span class="keyword">return</span> photos_[photo_id].info_en;
&#125;
</code></pre>

<h1 id="弹框类的头文件"><a href="#弹框类的头文件" class="headerlink" title="弹框类的头文件"></a>弹框类的头文件</h1><pre><code class="highlight cpp"><span class="keyword">class</span> <span class="title class_">DialogPhoto</span> : <span class="keyword">public</span> DialogPub
&#123;
<span class="keyword">public</span>:
    <span class="built_in">DIALOG_MAKE_FUNC</span>(DialogPhoto);
    <span class="built_in">CREATE_FUNC</span>(DialogPhoto);

    <span class="built_in">DialogPhoto</span>();

    <span class="comment">//初始化</span>
    <span class="function"><span class="type">void</span> <span class="title">of_init_ui</span><span class="params">()</span> <span class="keyword">override</span></span>;

    <span class="comment">//初始化左侧的列表框</span>
    <span class="function"><span class="type">void</span> <span class="title">of_init_listview</span><span class="params">()</span></span>;

    <span class="comment">// 根据图片索引，显示某张图的详情</span>
    <span class="function"><span class="type">void</span> <span class="title">of_init_single_photo</span><span class="params">(<span class="type">int</span> index)</span></span>;

    <span class="comment">//panel_for_touch的触摸回调</span>
    <span class="function"><span class="type">void</span> <span class="title">on_touch_piece</span><span class="params">(Ref* sender, Widget::TouchEventType type)</span></span>;

    <span class="comment">//切换照片</span>
    <span class="function"><span class="type">void</span> <span class="title">on_click_switch_photo</span><span class="params">(Ref* sender)</span></span>;

    <span class="comment">// 关闭</span>
    <span class="function"><span class="type">void</span> <span class="title">on_close</span><span class="params">()</span></span>;

    <span class="comment">//点击宝箱事件，三个宝箱，对应的index是012</span>
    <span class="function"><span class="type">void</span> <span class="title">on_touch_award_box</span><span class="params">(Ref* sender, Widget::TouchEventType type, <span class="type">int</span> box_index)</span></span>;

    <span class="comment">//更新宝箱按钮旁边的数字</span>
    <span class="function"><span class="type">void</span> <span class="title">refresh_award_box_label</span><span class="params">(<span class="type">int</span> photo_id)</span></span>;

    <span class="comment">//更新左侧列表框里的缩略图的显示</span>
    <span class="function"><span class="type">void</span> <span class="title">refresh_list_view_photo</span><span class="params">(<span class="type">int</span> photo_id)</span></span>;

    <span class="comment">//检查是否发奖，如果该发奖就发奖</span>
    <span class="function"><span class="type">void</span> <span class="title">check_need_award_box</span><span class="params">(<span class="type">int</span> photo_id)</span></span>;

    <span class="comment">//把单个的csb photo添加到指定的父节点上</span>
    <span class="function"><span class="type">void</span> <span class="title">of_add_photo_one</span><span class="params">(Widget* parent_wgt, <span class="type">int</span> photo_id, <span class="type">float</span> arg_scale)</span></span>;

    <span class="comment">//根据photo id找到对应的图片路径</span>
    <span class="function">string <span class="title">of_get_photo_path_by_id</span><span class="params">(<span class="type">int</span> li_photo_id)</span></span>;
    <span class="function">string <span class="title">of_get_gray_photo_path_by_id</span><span class="params">(<span class="type">int</span> li_photo_id)</span></span>;

    <span class="comment">//拼好之后，亮图淡入完成后的回调</span>
    <span class="function"><span class="type">void</span> <span class="title">of_callback_all_pieces_ok</span><span class="params">(<span class="type">int</span> li_photo_id)</span></span>;

    <span class="comment">//拼好一个碎片后</span>
    <span class="function"><span class="type">void</span> <span class="title">of_work_after_piece_status_turn_to_ok</span><span class="params">(<span class="type">int</span> li_photo_id, Vec2 piece_pos)</span></span>;
<span class="keyword">private</span>:
    <span class="comment">//底图是用美术出的图，还是程序用shader把亮图变暗</span>
    <span class="type">const</span> <span class="type">bool</span> kUseShader;

    <span class="comment">//csb根节点</span>
    Node* csb_root;

    <span class="comment">// 可以被触摸的碎片，即状态为已获得但没有归位的碎片</span>
    vector&lt;Sprite*&gt; m_touchable_pieces;

    <span class="comment">// 正在被触摸的碎片</span>
    Sprite* m_touching_piece;

    <span class="comment">//正在被触摸的碎片移动之前的位置</span>
    Vec2 m_touching_piece_pos_before_move;

    <span class="comment">//正在被触摸的碎片的父节点</span>
    Node* m_touching_piece_father_node;

    <span class="comment">//记录碎片的目的地位置</span>
    array&lt;Vec2, PHOTO_COLLECT_PIECE_COUNT&gt; i_piece_position_array;

    <span class="comment">//下拉宝箱的初始y坐标（三个宝箱都显示）</span>
    <span class="type">float</span> if_boxes_original_y_position;

    <span class="comment">//当前在看哪张图</span>
    <span class="type">int</span> i_current_photo_display;

    <span class="comment">//列表框里子项未选中时的缩放比例</span>
    <span class="type">float</span> i_listview_item_select_scale;

    <span class="comment">//列表框里子项未选中时的缩放比例</span>
    <span class="type">float</span> i_listview_item_normal_scale;
&#125;;</code></pre>

<h1 id="弹框类的实现文件"><a href="#弹框类的实现文件" class="headerlink" title="弹框类的实现文件"></a>弹框类的实现文件</h1><pre><code class="highlight cpp"><span class="meta">#<span class="keyword">pragma</span> region DialogPhoto</span>

DialogPhoto::<span class="built_in">DialogPhoto</span>()
    : <span class="built_in">kUseShader</span>(<span class="literal">true</span>)
&#123;
&#125;

<span class="function"><span class="type">void</span> <span class="title">DialogPhoto::of_init_ui</span><span class="params">()</span> </span>&#123;

    string ls_csb = <span class="string">&quot;csb_ui_photo/dialog_photocollect_new.csb&quot;</span>;
    <span class="comment">//目前只有“入”的动画，没有“出”的动画。入动画的最后一帧是58</span>
    <span class="keyword">auto</span> l_node_csb = PUI::<span class="built_in">of_create_dialog</span>(<span class="keyword">this</span>, ls_csb, <span class="number">0</span>, g.rrscale, <span class="number">60</span>);
    <span class="comment">//目前在csb文件里没有区分中英文，所以没有调用g.of_set_ui_by_country()</span>
    csb_root = l_node_csb;

    <span class="comment">//给关闭按钮添加回调</span>
    <span class="keyword">auto</span> l_button_close = (Button*)PUI::<span class="built_in">of_find_by_name</span>(l_node_csb, <span class="string">&quot;button_close&quot;</span>);
    l_button_close-&gt;<span class="built_in">addClickEventListener</span>(<span class="built_in">CC_CALLBACK_0</span>(DialogPhoto::on_close, <span class="keyword">this</span>));

    <span class="comment">//往列表框中加入已解锁的图，每张图的tag是它们的photo id</span>
    <span class="built_in">of_init_listview</span>();

    <span class="comment">//重新设置宝箱的y坐标，宝箱节点必须贴在屏幕的上边缘</span>
    &#123;
        <span class="keyword">auto</span> origin = Director::<span class="built_in">getInstance</span>()-&gt;<span class="built_in">getVisibleOrigin</span>();
        <span class="keyword">auto</span> visize = Director::<span class="built_in">getInstance</span>()-&gt;<span class="built_in">getVisibleSize</span>();
        <span class="keyword">auto</span> node = PUI::<span class="built_in">of_find_by_name</span>(l_node_csb, <span class="string">&quot;node_album_gift_top_pos&quot;</span>);
        <span class="keyword">auto</span> node_pos = node-&gt;<span class="built_in">getPosition</span>();
        <span class="keyword">auto</span> parent = node-&gt;<span class="built_in">getParent</span>();
        <span class="keyword">auto</span> world_pos = parent-&gt;<span class="built_in">convertToWorldSpace</span>(node_pos);
        <span class="keyword">auto</span> world_pos_1 = <span class="built_in">Vec2</span>(world_pos.x, origin.y + visize.height);
        <span class="keyword">auto</span> node_pos_1 = parent-&gt;<span class="built_in">convertToNodeSpace</span>(world_pos_1);
        node-&gt;<span class="built_in">setPosition</span>(node_pos_1);
        if_boxes_original_y_position = node_pos_<span class="number">1.</span>y;
    &#125;

    <span class="comment">//得到每个碎片的最终位置，存进i_piece_position_array这个成员变量里，一会儿用来判断碎片“归位”</span>
    &#123;
        <span class="keyword">auto</span> csb_file = CSLoader::<span class="built_in">createNode</span>(<span class="string">&quot;csb_ui_photo/node_photo_one.csb&quot;</span>);
        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; PHOTO_COLLECT_PIECE_COUNT; i++)
        &#123;
            <span class="keyword">auto</span> piece_node = PUI::<span class="built_in">of_find_by_name</span>(csb_file, StringUtils::format(<span class="string">&quot;sp_piece%d&quot;</span>, i));
            i_piece_position_array[i] = piece_node-&gt;<span class="built_in">getPosition</span>();
        &#125;
    &#125;

    <span class="comment">//给面板添加触摸回调</span>
    <span class="keyword">auto</span> panel_for_touch = (Layout*)PUI::<span class="built_in">of_find_by_name</span>(l_node_csb, <span class="string">&quot;panel_for_touch&quot;</span>);
    panel_for_touch-&gt;<span class="built_in">removeAllChildren</span>();
    panel_for_touch-&gt;<span class="built_in">addTouchEventListener</span>(<span class="built_in">CC_CALLBACK_2</span>(DialogPhoto::on_touch_piece, <span class="keyword">this</span>));

    <span class="comment">//给每个宝箱添加触摸回调，并隐藏每个宝箱的说明</span>
    <span class="keyword">auto</span> btn_box_1 = (Button*)PUI::<span class="built_in">of_find_by_name</span>(l_node_csb, <span class="string">&quot;btn_albumgiftbox_1&quot;</span>);
    <span class="keyword">auto</span> btn_box_2 = (Button*)PUI::<span class="built_in">of_find_by_name</span>(l_node_csb, <span class="string">&quot;btn_albumgiftbox_2&quot;</span>);
    <span class="keyword">auto</span> btn_box_3 = (Button*)PUI::<span class="built_in">of_find_by_name</span>(l_node_csb, <span class="string">&quot;btn_albumgiftbox_3&quot;</span>);
    btn_box_1-&gt;<span class="built_in">addTouchEventListener</span>(<span class="built_in">CC_CALLBACK_2</span>(DialogPhoto::on_touch_award_box, <span class="keyword">this</span>, <span class="number">0</span>));
    btn_box_2-&gt;<span class="built_in">addTouchEventListener</span>(<span class="built_in">CC_CALLBACK_2</span>(DialogPhoto::on_touch_award_box, <span class="keyword">this</span>, <span class="number">1</span>));
    btn_box_3-&gt;<span class="built_in">addTouchEventListener</span>(<span class="built_in">CC_CALLBACK_2</span>(DialogPhoto::on_touch_award_box, <span class="keyword">this</span>, <span class="number">2</span>));
    PUI::<span class="built_in">of_find_by_name</span>(l_node_csb, <span class="string">&quot;sp_albumgiftbox_info_1&quot;</span>)-&gt;<span class="built_in">setVisible</span>(<span class="literal">false</span>);
    PUI::<span class="built_in">of_find_by_name</span>(l_node_csb, <span class="string">&quot;sp_albumgiftbox_info_2&quot;</span>)-&gt;<span class="built_in">setVisible</span>(<span class="literal">false</span>);
    PUI::<span class="built_in">of_find_by_name</span>(l_node_csb, <span class="string">&quot;sp_albumgiftbox_info_3&quot;</span>)-&gt;<span class="built_in">setVisible</span>(<span class="literal">false</span>);

    <span class="comment">//在右侧显示详情</span>
    <span class="type">int</span> li_last_open_photo = g.candy_photo_collect-&gt;<span class="built_in">of_get_last_open_photo</span>();
    <span class="keyword">if</span> (li_last_open_photo != PHOTO_COLLECT_INVALID_PHOTO_ID)
    &#123;
        <span class="built_in">of_init_single_photo</span>(li_last_open_photo);
    &#125;
    <span class="keyword">else</span>
    &#123;
        <span class="built_in">of_init_single_photo</span>(<span class="number">999</span>);
    &#125;
&#125;

<span class="comment">//初始化左侧列表框</span>
<span class="function"><span class="type">void</span> <span class="title">DialogPhoto::of_init_listview</span><span class="params">()</span></span>
<span class="function"></span>&#123;
    <span class="keyword">auto</span> l_lsv = (ListView*)PUI::<span class="built_in">of_find_by_name</span>(csb_root, <span class="string">&quot;listview_photos&quot;</span>);
    l_lsv-&gt;<span class="built_in">removeAllChildren</span>();

    <span class="comment">//得到列表框的宽度 280</span>
    <span class="type">float</span> lf_lsv_w = l_lsv-&gt;<span class="built_in">getContentSize</span>().width;

    <span class="comment">//得到一张图的宽高</span>
    <span class="type">float</span> lf_photo_w = <span class="number">856</span>;
    <span class="type">float</span> lf_photo_h = <span class="number">900</span>;

    <span class="comment">//计算列表框里子项未选中时的缩放比例</span>
    <span class="type">float</span> lf_item_width = lf_lsv_w - <span class="number">20</span>;<span class="comment">//260，没选中时的宽度</span>
    i_listview_item_normal_scale = lf_item_width / lf_photo_w;<span class="comment">//没选中时的缩放</span>
    <span class="type">float</span> lf_item_height = lf_photo_h * i_listview_item_normal_scale;<span class="comment">//没选中时的高度</span>

    <span class="comment">//计算列表框里子项选中时的缩放比例</span>
    i_listview_item_select_scale = lf_lsv_w / lf_item_width;

    <span class="comment">//得到已经解锁的所有photo的id的集合</span>
    <span class="keyword">auto</span> l_vector_unlock_photos_id = g.candy_photo_collect-&gt;<span class="built_in">of_get_unlock_photos</span>();

    <span class="comment">//得到最近得到的碎片所属于的photo id</span>
    <span class="type">int</span> li_last_open_photo = g.candy_photo_collect-&gt;<span class="built_in">of_get_last_open_photo</span>();

    <span class="keyword">for</span> (<span class="keyword">auto</span> i : l_vector_unlock_photos_id)
    &#123;
        <span class="keyword">auto</span> panel = Layout::<span class="built_in">create</span>();
        panel-&gt;<span class="built_in">setAnchorPoint</span>(Vec2::ANCHOR_MIDDLE);
        panel-&gt;<span class="built_in">setContentSize</span>(<span class="built_in">Size</span>(lf_item_width, lf_item_height));
        panel-&gt;<span class="built_in">setTag</span>(i);
        panel-&gt;<span class="built_in">setTouchEnabled</span>(<span class="literal">true</span>);
        panel-&gt;<span class="built_in">addClickEventListener</span>(<span class="built_in">CC_CALLBACK_1</span>(DialogPhoto::on_click_switch_photo, <span class="keyword">this</span>));
        l_lsv-&gt;<span class="built_in">pushBackCustomItem</span>(panel);

        <span class="comment">//加载csb到这个widget上</span>
        <span class="built_in">of_add_photo_one</span>(panel, i, i_listview_item_normal_scale);
    &#125;

    <span class="comment">//在列表框尾部添加“敬请期待”</span>
    &#123;
        <span class="keyword">auto</span> panel = Layout::<span class="built_in">create</span>();
        panel-&gt;<span class="built_in">setAnchorPoint</span>(Vec2::ANCHOR_MIDDLE);
        panel-&gt;<span class="built_in">setContentSize</span>(<span class="built_in">Size</span>(lf_item_width, lf_item_height));
        panel-&gt;<span class="built_in">setTag</span>(<span class="number">999</span>);
        panel-&gt;<span class="built_in">setTouchEnabled</span>(<span class="literal">true</span>);
        panel-&gt;<span class="built_in">addClickEventListener</span>(<span class="built_in">CC_CALLBACK_1</span>(DialogPhoto::on_click_switch_photo, <span class="keyword">this</span>));
        l_lsv-&gt;<span class="built_in">pushBackCustomItem</span>(panel);
        <span class="keyword">auto</span> spr = Sprite::<span class="built_in">create</span>(<span class="string">&quot;photoes/coming_soon/999_normal.png&quot;</span>);
        spr-&gt;<span class="built_in">setPosition</span>(<span class="built_in">Vec2</span>(lf_item_width / <span class="number">2</span>, lf_item_height / <span class="number">2</span>));
        spr-&gt;<span class="built_in">setScale</span>(i_listview_item_normal_scale);
        panel-&gt;<span class="built_in">addChild</span>(spr);
        string ls_name_path = g.is_country == <span class="string">&quot;zh&quot;</span> ? <span class="string">&quot;photoes/coming_soon/photo_name_999_zh.png&quot;</span> : <span class="string">&quot;photoes/coming_soon/photo_name_999.png&quot;</span>;
        <span class="keyword">auto</span> spr_name = Sprite::<span class="built_in">create</span>(ls_name_path);
        spr_name-&gt;<span class="built_in">setPosition</span>(<span class="built_in">Vec2</span>(<span class="number">367</span>, <span class="number">75</span>));
        spr-&gt;<span class="built_in">addChild</span>(spr_name);
        <span class="keyword">auto</span> spr2 = Sprite::<span class="built_in">create</span>(<span class="string">&quot;photoes/coming_soon/999_co.png&quot;</span>);
        spr2-&gt;<span class="built_in">setScale</span>(<span class="number">1.99f</span>);
        spr2-&gt;<span class="built_in">setPosition</span>(<span class="built_in">Vec2</span>(spr-&gt;<span class="built_in">getContentSize</span>().width / <span class="number">2</span>, spr-&gt;<span class="built_in">getContentSize</span>().height / <span class="number">2</span>));
        spr-&gt;<span class="built_in">addChild</span>(spr2);
    &#125;
&#125;

<span class="comment">//显示单张图</span>
<span class="function"><span class="type">void</span> <span class="title">DialogPhoto::of_init_single_photo</span><span class="params">(<span class="type">int</span> photo_id)</span></span>
<span class="function"></span>&#123;
    m_touchable_pieces.<span class="built_in">clear</span>();
    <span class="keyword">auto</span> panel_for_touch = (Layout*)PUI::<span class="built_in">of_find_by_name</span>(csb_root, <span class="string">&quot;panel_for_touch&quot;</span>);
    panel_for_touch-&gt;<span class="built_in">removeAllChildren</span>();

    <span class="keyword">if</span> (photo_id == <span class="number">999</span>)
    &#123;
        <span class="keyword">auto</span> sp = Sprite::<span class="built_in">create</span>(<span class="string">&quot;photoes/coming_soon/999_normal.png&quot;</span>);
        sp-&gt;<span class="built_in">setPosition</span>(<span class="built_in">Vec2</span>(panel_for_touch-&gt;<span class="built_in">getContentSize</span>().width / <span class="number">2</span>, panel_for_touch-&gt;<span class="built_in">getContentSize</span>().height / <span class="number">2</span>));
        panel_for_touch-&gt;<span class="built_in">addChild</span>(sp);
        <span class="keyword">auto</span> spr2 = Sprite::<span class="built_in">create</span>(<span class="string">&quot;photoes/coming_soon/999_co.png&quot;</span>);
        spr2-&gt;<span class="built_in">setScale</span>(<span class="number">1.996f</span>);
        spr2-&gt;<span class="built_in">setPosition</span>(<span class="built_in">Vec2</span>(sp-&gt;<span class="built_in">getContentSize</span>().width / <span class="number">2</span>, sp-&gt;<span class="built_in">getContentSize</span>().height / <span class="number">2</span>));
        sp-&gt;<span class="built_in">addChild</span>(spr2);
        string ls_name_path = g.is_country == <span class="string">&quot;zh&quot;</span> ? <span class="string">&quot;photoes/coming_soon/photo_name_999_zh.png&quot;</span> : <span class="string">&quot;photoes/coming_soon/photo_name_999.png&quot;</span>;
        <span class="keyword">auto</span> spr_name = Sprite::<span class="built_in">create</span>(ls_name_path);
        spr_name-&gt;<span class="built_in">setPosition</span>(<span class="built_in">Vec2</span>(<span class="number">367</span>, <span class="number">75</span>));
        sp-&gt;<span class="built_in">addChild</span>(spr_name);
        PUI::<span class="built_in">of_find_by_name</span>(<span class="keyword">this</span>, <span class="string">&quot;node_album_gift_top_pos&quot;</span>)-&gt;<span class="built_in">setVisible</span>(<span class="literal">false</span>);
        <span class="comment">//当photo_id是999时，没有给i_current_photo_display赋值，也不影响</span>
        <span class="keyword">return</span>;
    &#125;

    i_current_photo_display = photo_id;

    <span class="keyword">auto</span> csb_file = CSLoader::<span class="built_in">createNode</span>(<span class="string">&quot;csb_ui_photo/node_photo_one.csb&quot;</span>);
    <span class="keyword">auto</span> csb_act = CSLoader::<span class="built_in">createTimeline</span>(<span class="string">&quot;csb_ui_photo/node_photo_one.csb&quot;</span>);
    panel_for_touch-&gt;<span class="built_in">addChild</span>(csb_file);
    csb_file-&gt;<span class="built_in">runAction</span>(csb_act);
    csb_act-&gt;<span class="built_in">gotoFrameAndPlay</span>(<span class="number">0</span>, <span class="number">60</span>, <span class="literal">false</span>);

    <span class="comment">//查询该图拼完没有</span>
    <span class="type">int</span> ok_piece_cnt = g.candy_photo_collect-&gt;<span class="built_in">of_get_photo_ok_piece_count</span>(photo_id);
    <span class="keyword">if</span> (ok_piece_cnt &lt; PHOTO_COLLECT_PIECE_COUNT)
    &#123;
        <span class="comment">//显示底图</span>
        <span class="keyword">auto</span> l_sp_shadow_one = (Sprite*)PUI::<span class="built_in">of_find_by_name</span>(csb_file, <span class="string">&quot;sp_photo_shadow_bg&quot;</span>);
        l_sp_shadow_one-&gt;<span class="built_in">setVisible</span>(<span class="literal">true</span>);
        <span class="keyword">if</span> (kUseShader)
        &#123;
            PUI::<span class="built_in">of_sprite_set_texture</span>(l_sp_shadow_one, <span class="built_in">of_get_photo_path_by_id</span>(photo_id));
            PUI::<span class="built_in">of_node_set_gray</span>(l_sp_shadow_one);
        &#125;
        <span class="keyword">else</span>
        &#123;
            PUI::<span class="built_in">of_sprite_set_texture</span>(l_sp_shadow_one, <span class="built_in">of_get_gray_photo_path_by_id</span>(photo_id));
        &#125;
        <span class="comment">//显示碎片</span>
        <span class="keyword">auto</span> arr = g.candy_photo_collect-&gt;<span class="built_in">of_get_pieces</span>(photo_id);
        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; PHOTO_COLLECT_PIECE_COUNT; i++)
        &#123;
            <span class="keyword">auto</span> piece_sprite = (Sprite*)PUI::<span class="built_in">of_find_by_name</span>(csb_file, StringUtils::format(<span class="string">&quot;sp_piece%d&quot;</span>, i));
            piece_sprite-&gt;<span class="built_in">setCascadeOpacityEnabled</span>(<span class="literal">true</span>);
            piece_sprite-&gt;<span class="built_in">setTag</span>(i);
            <span class="type">int</span> piece_status = arr[i];
            <span class="keyword">if</span> (piece_status == <span class="number">0</span>)
            &#123;
                piece_sprite-&gt;<span class="built_in">setVisible</span>(<span class="literal">false</span>);<span class="comment">//未得到的碎片不显示</span>
                <span class="keyword">continue</span>;
            &#125;

            <span class="keyword">auto</span> piece_pos = piece_sprite-&gt;<span class="built_in">getPosition</span>();
            <span class="keyword">auto</span> piece_size = piece_sprite-&gt;<span class="built_in">getContentSize</span>();

            <span class="keyword">auto</span> sp_stencil = Sprite::<span class="built_in">create</span>(piece_sprite-&gt;<span class="built_in">getTexture</span>()-&gt;<span class="built_in">getPath</span>());
            <span class="keyword">auto</span> node_clip = ClippingNode::<span class="built_in">create</span>(sp_stencil);
            node_clip-&gt;<span class="built_in">setAlphaThreshold</span>(<span class="number">0</span>);
            node_clip-&gt;<span class="built_in">setInverted</span>(<span class="literal">false</span>);
            node_clip-&gt;<span class="built_in">setPosition</span>(<span class="built_in">Vec2</span>(piece_size.width / <span class="number">2</span>, piece_size.height / <span class="number">2</span>));
            node_clip-&gt;<span class="built_in">setCascadeOpacityEnabled</span>(<span class="literal">true</span>);
            piece_sprite-&gt;<span class="built_in">addChild</span>(node_clip);

            <span class="keyword">auto</span> sp_content = Sprite::<span class="built_in">create</span>(<span class="built_in">of_get_photo_path_by_id</span>(photo_id));
            sp_content-&gt;<span class="built_in">setAnchorPoint</span>(Vec2::ANCHOR_BOTTOM_LEFT);
            sp_content-&gt;<span class="built_in">setPosition</span>(<span class="built_in">Vec2</span>(<span class="number">10</span> - piece_pos.x, <span class="number">130</span> - piece_pos.y));
            node_clip-&gt;<span class="built_in">addChild</span>(sp_content);

            <span class="keyword">auto</span> sp_shield = Sprite::<span class="built_in">create</span>(StringUtils::format(<span class="string">&quot;photoes/ui/001_%d_1.png&quot;</span>, i));
            sp_shield-&gt;<span class="built_in">setPosition</span>(<span class="built_in">Vec2</span>(piece_size.width / <span class="number">2</span>, piece_size.height / <span class="number">2</span>));
            sp_shield-&gt;<span class="built_in">setCascadeOpacityEnabled</span>(<span class="literal">true</span>);
            piece_sprite-&gt;<span class="built_in">addChild</span>(sp_shield);

            <span class="keyword">if</span> (piece_status == <span class="number">1</span>)<span class="comment">//没有归位的碎片，打乱位置显示</span>
            &#123;
                <span class="type">int</span> n = m_touchable_pieces.<span class="built_in">size</span>();
                piece_sprite-&gt;<span class="built_in">setPosition</span>(<span class="built_in">Vec2</span>(<span class="number">150</span> + <span class="number">30</span> * n, <span class="number">100</span>));
                piece_sprite-&gt;<span class="built_in">setLocalZOrder</span>(<span class="number">2</span>);
                m_touchable_pieces.<span class="built_in">push_back</span>(piece_sprite);
            &#125;
        &#125;
        <span class="comment">//隐藏亮图</span>
        <span class="keyword">auto</span> sp_normal_one = (Sprite*)PUI::<span class="built_in">of_find_by_name</span>(csb_file, <span class="string">&quot;sp_photo_normal_bg&quot;</span>);
        sp_normal_one-&gt;<span class="built_in">setVisible</span>(<span class="literal">false</span>);
    &#125;
    <span class="keyword">else</span>
    &#123;
        <span class="comment">//隐藏底图</span>
        <span class="keyword">auto</span> l_sp_shadow_one = (Sprite*)PUI::<span class="built_in">of_find_by_name</span>(csb_file, <span class="string">&quot;sp_photo_shadow_bg&quot;</span>);
        l_sp_shadow_one-&gt;<span class="built_in">setVisible</span>(<span class="literal">false</span>);
        <span class="comment">//隐藏碎片</span>
        PUI::<span class="built_in">of_find_by_name</span>(csb_file, <span class="string">&quot;node_pieces&quot;</span>)-&gt;<span class="built_in">setVisible</span>(<span class="literal">false</span>);
        <span class="comment">//显示亮图</span>
        <span class="keyword">auto</span> sp_normal_one = (Sprite*)PUI::<span class="built_in">of_find_by_name</span>(csb_file, <span class="string">&quot;sp_photo_normal_bg&quot;</span>);
        PUI::<span class="built_in">of_sprite_set_texture</span>(sp_normal_one, <span class="built_in">of_get_photo_path_by_id</span>(photo_id));
        sp_normal_one-&gt;<span class="built_in">setCascadeOpacityEnabled</span>(<span class="literal">true</span>);
    &#125;

    <span class="comment">//不显示节日名</span>
    PUI::<span class="built_in">of_find_by_name</span>(csb_file, <span class="string">&quot;txt_name_en&quot;</span>)-&gt;<span class="built_in">setVisible</span>(<span class="literal">false</span>);
    PUI::<span class="built_in">of_find_by_name</span>(csb_file, <span class="string">&quot;txt_name_zh&quot;</span>)-&gt;<span class="built_in">setVisible</span>(<span class="literal">false</span>);

    <span class="comment">//显示节日说明</span>
    <span class="keyword">auto</span> photo_text_en = (Text*)PUI::<span class="built_in">of_find_by_name</span>(csb_file, <span class="string">&quot;txt_info_en&quot;</span>);
    <span class="keyword">auto</span> photo_text_zh = (Text*)PUI::<span class="built_in">of_find_by_name</span>(csb_file, <span class="string">&quot;txt_info_zh&quot;</span>);
    <span class="keyword">if</span> (ok_piece_cnt &lt; PHOTO_COLLECT_PIECE_COUNT)
    &#123;
        photo_text_en-&gt;<span class="built_in">setVisible</span>(<span class="literal">false</span>);
        photo_text_zh-&gt;<span class="built_in">setVisible</span>(<span class="literal">false</span>);
    &#125;
    <span class="keyword">else</span>
    &#123;
        photo_text_en-&gt;<span class="built_in">setString</span>(g.candy_photo_collect-&gt;<span class="built_in">of_get_introduce</span>(photo_id, g.is_country));
        photo_text_zh-&gt;<span class="built_in">setString</span>(g.candy_photo_collect-&gt;<span class="built_in">of_get_introduce</span>(photo_id, g.is_country));
        photo_text_en-&gt;<span class="built_in">setVisible</span>(g.is_country == <span class="string">&quot;zh&quot;</span> ? <span class="literal">false</span> : <span class="literal">true</span>);
        photo_text_zh-&gt;<span class="built_in">setVisible</span>(g.is_country == <span class="string">&quot;zh&quot;</span> ? <span class="literal">true</span> : <span class="literal">false</span>);
    &#125;

    <span class="comment">//显示宝箱上的数字</span>
    <span class="built_in">refresh_award_box_label</span>(photo_id);

    PUI::<span class="built_in">of_find_by_name</span>(csb_root, <span class="string">&quot;sp_albumgiftbox_info_1&quot;</span>)-&gt;<span class="built_in">setVisible</span>(<span class="literal">false</span>);
    PUI::<span class="built_in">of_find_by_name</span>(csb_root, <span class="string">&quot;sp_albumgiftbox_info_2&quot;</span>)-&gt;<span class="built_in">setVisible</span>(<span class="literal">false</span>);
    PUI::<span class="built_in">of_find_by_name</span>(csb_root, <span class="string">&quot;sp_albumgiftbox_info_3&quot;</span>)-&gt;<span class="built_in">setVisible</span>(<span class="literal">false</span>);
&#125;

<span class="comment">//点击碎片的回调</span>
<span class="function"><span class="type">void</span> <span class="title">DialogPhoto::on_touch_piece</span><span class="params">(Ref* sender, Widget::TouchEventType type)</span></span>
<span class="function"></span>&#123;
    <span class="keyword">auto</span> lyt = <span class="built_in">dynamic_cast</span>&lt;Layout*&gt;(sender);
    <span class="keyword">if</span> (type == Widget::TouchEventType::BEGAN)
    &#123;
        m_touching_piece = <span class="literal">nullptr</span>;
        <span class="keyword">auto</span> pos_world = lyt-&gt;<span class="built_in">getTouchBeganPosition</span>();
        <span class="keyword">for</span> (<span class="keyword">auto</span> it = m_touchable_pieces.<span class="built_in">crbegin</span>(); it != m_touchable_pieces.<span class="built_in">crend</span>(); ++it)
        &#123;
            <span class="keyword">auto</span> sp_size = (*it)-&gt;<span class="built_in">getContentSize</span>();
            <span class="keyword">auto</span> pos_node = (*it)-&gt;<span class="built_in">convertToNodeSpace</span>(pos_world);
            <span class="keyword">if</span> (pos_node.x &gt; <span class="number">0</span>
                &amp;&amp; pos_node.x &lt; sp_size.width
                &amp;&amp; pos_node.y &gt; <span class="number">0</span>
                &amp;&amp; pos_node.y &lt; sp_size.height)
            &#123;
                m_touching_piece = (*it);
                m_touching_piece-&gt;<span class="built_in">setLocalZOrder</span>(<span class="number">3</span>);<span class="comment">//正在被拖动的碎片的层级比其他碎片高</span>
                m_touching_piece_pos_before_move = m_touching_piece-&gt;<span class="built_in">getPosition</span>();
                m_touching_piece_father_node = m_touching_piece-&gt;<span class="built_in">getParent</span>();
                <span class="keyword">break</span>;
            &#125;
        &#125;
        <span class="keyword">if</span> (m_touching_piece)
        &#123;
            <span class="keyword">for</span> (<span class="keyword">auto</span> it = m_touchable_pieces.<span class="built_in">crbegin</span>(); it != m_touchable_pieces.<span class="built_in">crend</span>(); ++it)
            &#123;
                (*it)-&gt;<span class="built_in">setVisible</span>((*it) == m_touching_piece);
            &#125;
        &#125;
    &#125;
    <span class="keyword">else</span> <span class="keyword">if</span> (type == Widget::TouchEventType::MOVED)
    &#123;
        <span class="keyword">if</span> (m_touching_piece)
        &#123;
            <span class="keyword">auto</span> size_touching_sp = m_touching_piece-&gt;<span class="built_in">getContentSize</span>();
            <span class="keyword">auto</span> touch_pos_1 = m_touching_piece_father_node-&gt;<span class="built_in">convertToNodeSpace</span>(lyt-&gt;<span class="built_in">getTouchBeganPosition</span>());
            <span class="keyword">auto</span> touch_pos_2 = m_touching_piece_father_node-&gt;<span class="built_in">convertToNodeSpace</span>(lyt-&gt;<span class="built_in">getTouchMovePosition</span>());
            <span class="keyword">auto</span> touch_pos_delta = touch_pos_2 - touch_pos_1;
            <span class="keyword">auto</span> new_pos = m_touching_piece_pos_before_move + touch_pos_delta;
            <span class="type">bool</span> x_can_move = (new_pos.x &gt; <span class="number">0</span> + size_touching_sp.width / <span class="number">2</span> - <span class="number">65</span>) &amp;&amp; (new_pos.x &lt; lyt-&gt;<span class="built_in">getContentSize</span>().width - size_touching_sp.width / <span class="number">2</span> - <span class="number">65</span>);
            <span class="type">bool</span> y_can_move = (new_pos.y &gt; <span class="number">0</span> + size_touching_sp.height / <span class="number">2</span> - <span class="number">18</span>) &amp;&amp; (new_pos.y &lt; lyt-&gt;<span class="built_in">getContentSize</span>().height - size_touching_sp.height / <span class="number">2</span> - <span class="number">18</span>);
            <span class="keyword">if</span> (x_can_move || y_can_move)<span class="comment">//移动不能超出父容器</span>
            &#123;
                <span class="keyword">if</span> (x_can_move &amp;&amp; y_can_move)
                &#123;
                    <span class="keyword">auto</span> destination_position = i_piece_position_array[m_touching_piece-&gt;<span class="built_in">getTag</span>()];
                    <span class="keyword">if</span> (<span class="built_in">abs</span>(new_pos.x - destination_position.x) &lt; <span class="number">8</span> &amp;&amp; <span class="built_in">abs</span>(new_pos.y - destination_position.y) &lt; <span class="number">8</span>)<span class="comment">//靠近目标位置就吸附上去</span>
                    &#123;
                        m_touching_piece-&gt;<span class="built_in">setPosition</span>(destination_position);
                        m_touching_piece-&gt;<span class="built_in">setLocalZOrder</span>(<span class="number">1</span>);
                        <span class="comment">//碎片归位之后，播放一个光效</span>
                        PUI::<span class="built_in">of_create_movie_by_csb_once</span>(m_touching_piece, <span class="string">&quot;csb_ui_awardbox/node_effect_end_par.csb&quot;</span>, m_touching_piece-&gt;<span class="built_in">getContentSize</span>().width / <span class="number">2</span>, m_touching_piece-&gt;<span class="built_in">getContentSize</span>().height / <span class="number">2</span>, <span class="number">1.4f</span>, <span class="number">1.4f</span>);
                        <span class="keyword">for</span> (<span class="keyword">auto</span> it = m_touchable_pieces.<span class="built_in">begin</span>(); it != m_touchable_pieces.<span class="built_in">end</span>(); ++it)<span class="comment">//碎片归位后，把它从可移动的碎片vector里移除</span>
                        &#123;
                            <span class="keyword">if</span> (*it == m_touching_piece)
                            &#123;
                                m_touchable_pieces.<span class="built_in">erase</span>(it);
                                <span class="keyword">break</span>;
                            &#125;
                        &#125;
                        <span class="comment">//存档，这里是更新当前显示这张图的某个碎片的状态</span>
                        g.candy_photo_collect-&gt;<span class="built_in">of_set_piece_status</span>(i_current_photo_display, m_touching_piece-&gt;<span class="built_in">getTag</span>(), <span class="number">2</span>);
                        <span class="comment">//把正在触摸的碎片置空</span>
                        m_touching_piece = <span class="literal">nullptr</span>;
                        <span class="comment">//拼好之后要做哪些事</span>
                        <span class="built_in">of_work_after_piece_status_turn_to_ok</span>(i_current_photo_display, destination_position);
                    &#125;
                    <span class="keyword">else</span>
                    &#123;
                        m_touching_piece-&gt;<span class="built_in">setPosition</span>(new_pos);
                    &#125;
                &#125;
                <span class="keyword">else</span> <span class="keyword">if</span> (x_can_move)
                &#123;
                    m_touching_piece-&gt;<span class="built_in">setPositionX</span>(new_pos.x);
                &#125;
                <span class="keyword">else</span>
                &#123;
                    m_touching_piece-&gt;<span class="built_in">setPositionY</span>(new_pos.y);
                &#125;
            &#125;
        &#125;
    &#125;
    <span class="keyword">else</span> <span class="keyword">if</span> (type == Widget::TouchEventType::ENDED)
    &#123;
        m_touching_piece = <span class="literal">nullptr</span>;
        <span class="keyword">for</span> (<span class="keyword">auto</span> sp : m_touchable_pieces)
        &#123;
            sp-&gt;<span class="built_in">setVisible</span>(<span class="literal">true</span>);
            sp-&gt;<span class="built_in">setLocalZOrder</span>(<span class="number">2</span>);
        &#125;
    &#125;
    <span class="keyword">else</span> <span class="keyword">if</span> (type == Widget::TouchEventType::CANCELED)
    &#123;
        m_touching_piece = <span class="literal">nullptr</span>;
        <span class="keyword">for</span> (<span class="keyword">auto</span> sp : m_touchable_pieces)
        &#123;
            sp-&gt;<span class="built_in">setVisible</span>(<span class="literal">true</span>);
            sp-&gt;<span class="built_in">setLocalZOrder</span>(<span class="number">2</span>);
        &#125;
    &#125;
&#125;

<span class="comment">//点击左侧的列表框，切换照片</span>
<span class="function"><span class="type">void</span> <span class="title">DialogPhoto::on_click_switch_photo</span><span class="params">(Ref * sender)</span></span>
<span class="function"></span>&#123;
    <span class="keyword">auto</span> wgt = <span class="built_in">dynamic_cast</span>&lt;Widget*&gt;(sender);
    <span class="keyword">auto</span> lsv = (ListView*)PUI::<span class="built_in">of_find_by_name</span>(csb_root, <span class="string">&quot;listview_photos&quot;</span>);
    <span class="keyword">auto</span> items = lsv-&gt;<span class="built_in">getItems</span>();
    <span class="keyword">for</span> (<span class="keyword">auto</span> item : items)
    &#123;
        <span class="keyword">if</span> (wgt == item)
        &#123;
            item-&gt;<span class="built_in">setScale</span>(i_listview_item_select_scale);
        &#125;
        <span class="keyword">else</span>
        &#123;
            item-&gt;<span class="built_in">setScale</span>(<span class="number">1</span>);
        &#125;
    &#125;
    <span class="type">int</span> tag = wgt-&gt;<span class="built_in">getTag</span>();<span class="comment">//这个tag就是图片的ID</span>
    <span class="built_in">of_init_single_photo</span>(tag);
&#125;

<span class="comment">//点击关闭的回调</span>
<span class="function"><span class="type">void</span> <span class="title">DialogPhoto::on_close</span><span class="params">()</span> </span>&#123;

    <span class="keyword">if</span> (dialog_listener != <span class="literal">nullptr</span>) &#123;
        dialog_listener-&gt;<span class="built_in">doDialogAction</span>(<span class="keyword">this</span>, DialogAction::dialog_photo_close);
    &#125;
    <span class="built_in">of_close_dialog</span>();
    g.<span class="built_in">play_sound</span>(<span class="string">&quot;music/sound_button_clicked.mp3&quot;</span>);
&#125;

<span class="comment">//点击右侧的宝箱，显示这个宝箱的奖励内容</span>
<span class="function"><span class="type">void</span> <span class="title">DialogPhoto::on_touch_award_box</span><span class="params">(Ref* sender, Widget::TouchEventType type, <span class="type">int</span> box_index)</span></span>
<span class="function"></span>&#123;
    <span class="keyword">if</span> (type == Widget::TouchEventType::BEGAN)
    &#123;
        <span class="keyword">auto</span> n1 = PUI::<span class="built_in">of_find_by_name</span>(<span class="keyword">this</span>, <span class="string">&quot;sp_albumgiftbox_info_1&quot;</span>);
        <span class="keyword">auto</span> n2 = PUI::<span class="built_in">of_find_by_name</span>(<span class="keyword">this</span>, <span class="string">&quot;sp_albumgiftbox_info_2&quot;</span>);
        <span class="keyword">auto</span> n3 = PUI::<span class="built_in">of_find_by_name</span>(<span class="keyword">this</span>, <span class="string">&quot;sp_albumgiftbox_info_3&quot;</span>);

        <span class="keyword">auto</span> act2 = Show::<span class="built_in">create</span>();
        <span class="keyword">auto</span> act3 = DelayTime::<span class="built_in">create</span>(<span class="number">2.3f</span>);
        <span class="keyword">auto</span> act4 = Hide::<span class="built_in">create</span>();
        <span class="keyword">auto</span> act = Sequence::<span class="built_in">create</span>(act2, act3, act4, <span class="literal">nullptr</span>);
        <span class="keyword">if</span> (box_index == <span class="number">0</span>)
        &#123;
            <span class="keyword">if</span> (n1-&gt;<span class="built_in">isVisible</span>() == <span class="literal">false</span>) n1-&gt;<span class="built_in">runAction</span>(act);
            n2-&gt;<span class="built_in">setVisible</span>(<span class="literal">false</span>);
            n3-&gt;<span class="built_in">setVisible</span>(<span class="literal">false</span>);
        &#125;
        <span class="keyword">else</span> <span class="keyword">if</span> (box_index == <span class="number">1</span>)
        &#123;
            n1-&gt;<span class="built_in">setVisible</span>(<span class="literal">false</span>);
            <span class="keyword">if</span> (n2-&gt;<span class="built_in">isVisible</span>() == <span class="literal">false</span>) n2-&gt;<span class="built_in">runAction</span>(act);
            n3-&gt;<span class="built_in">setVisible</span>(<span class="literal">false</span>);
        &#125;
        <span class="keyword">else</span> <span class="keyword">if</span> (box_index == <span class="number">2</span>)
        &#123;
            n1-&gt;<span class="built_in">setVisible</span>(<span class="literal">false</span>);
            n2-&gt;<span class="built_in">setVisible</span>(<span class="literal">false</span>);
            <span class="keyword">if</span> (n3-&gt;<span class="built_in">isVisible</span>() == <span class="literal">false</span>) n3-&gt;<span class="built_in">runAction</span>(act);
        &#125;
    &#125;
&#125;

<span class="comment">//更新宝箱下面的数字显示</span>
<span class="function"><span class="type">void</span> <span class="title">DialogPhoto::refresh_award_box_label</span><span class="params">(<span class="type">int</span> photo_id)</span></span>
<span class="function"></span>&#123;
    <span class="keyword">auto</span> node_boxes_parent = PUI::<span class="built_in">of_find_by_name</span>(csb_root, <span class="string">&quot;node_album_gift_top_pos&quot;</span>);
    node_boxes_parent-&gt;<span class="built_in">setVisible</span>(<span class="literal">true</span>);
    <span class="keyword">auto</span> fnt_box_1 = (TextBMFont*)PUI::<span class="built_in">of_find_by_name</span>(<span class="keyword">this</span>, <span class="string">&quot;fnt_albumgiftbox_1&quot;</span>);
    <span class="keyword">auto</span> fnt_box_2 = (TextBMFont*)PUI::<span class="built_in">of_find_by_name</span>(<span class="keyword">this</span>, <span class="string">&quot;fnt_albumgiftbox_2&quot;</span>);
    <span class="keyword">auto</span> fnt_box_3 = (TextBMFont*)PUI::<span class="built_in">of_find_by_name</span>(<span class="keyword">this</span>, <span class="string">&quot;fnt_albumgiftbox_3&quot;</span>);
    <span class="type">int</span> ok_piece_cnt = g.candy_photo_collect-&gt;<span class="built_in">of_get_photo_ok_piece_count</span>(photo_id);
    <span class="keyword">auto</span> box1 = PUI::<span class="built_in">of_find_by_name</span>(node_boxes_parent, <span class="string">&quot;node_albumgiftbox_1&quot;</span>);
    <span class="keyword">auto</span> box2 = PUI::<span class="built_in">of_find_by_name</span>(node_boxes_parent, <span class="string">&quot;node_albumgiftbox_2&quot;</span>);
    <span class="keyword">auto</span> box3 = PUI::<span class="built_in">of_find_by_name</span>(node_boxes_parent, <span class="string">&quot;node_albumgiftbox_3&quot;</span>);
    <span class="keyword">if</span> (ok_piece_cnt &gt;= <span class="number">16</span>)
    &#123;
        box1-&gt;<span class="built_in">setVisible</span>(<span class="literal">false</span>);
        box2-&gt;<span class="built_in">setVisible</span>(<span class="literal">false</span>);
        box3-&gt;<span class="built_in">setVisible</span>(<span class="literal">false</span>);
        fnt_box_1-&gt;<span class="built_in">setString</span>(<span class="string">&quot;3/3&quot;</span>);
        fnt_box_2-&gt;<span class="built_in">setString</span>(<span class="string">&quot;9/9&quot;</span>);
        fnt_box_3-&gt;<span class="built_in">setString</span>(<span class="string">&quot;16/16&quot;</span>);
    &#125;
    <span class="keyword">else</span> <span class="keyword">if</span> (ok_piece_cnt &gt;= <span class="number">9</span>)
    &#123;
        box1-&gt;<span class="built_in">setVisible</span>(<span class="literal">false</span>);
        box2-&gt;<span class="built_in">setVisible</span>(<span class="literal">false</span>);
        box3-&gt;<span class="built_in">setVisible</span>(<span class="literal">true</span>);
        node_boxes_parent-&gt;<span class="built_in">setPositionY</span>(if_boxes_original_y_position + <span class="number">447</span>);
        fnt_box_1-&gt;<span class="built_in">setString</span>(<span class="string">&quot;3/3&quot;</span>);
        fnt_box_2-&gt;<span class="built_in">setString</span>(<span class="string">&quot;9/9&quot;</span>);
        fnt_box_3-&gt;<span class="built_in">setString</span>(StringUtils::format(<span class="string">&quot;%d/16&quot;</span>, ok_piece_cnt));
    &#125;
    <span class="keyword">else</span> <span class="keyword">if</span> (ok_piece_cnt &gt;= <span class="number">3</span>)
    &#123;
        box1-&gt;<span class="built_in">setVisible</span>(<span class="literal">false</span>);
        box2-&gt;<span class="built_in">setVisible</span>(<span class="literal">true</span>);
        box3-&gt;<span class="built_in">setVisible</span>(<span class="literal">true</span>);
        node_boxes_parent-&gt;<span class="built_in">setPositionY</span>(if_boxes_original_y_position + <span class="number">224</span>);
        fnt_box_1-&gt;<span class="built_in">setString</span>(<span class="string">&quot;3/3&quot;</span>);
        fnt_box_2-&gt;<span class="built_in">setString</span>(StringUtils::format(<span class="string">&quot;%d/9&quot;</span>, ok_piece_cnt));
        fnt_box_3-&gt;<span class="built_in">setString</span>(StringUtils::format(<span class="string">&quot;%d/16&quot;</span>, ok_piece_cnt));
    &#125;
    <span class="keyword">else</span>
    &#123;
        box1-&gt;<span class="built_in">setVisible</span>(<span class="literal">true</span>);
        box2-&gt;<span class="built_in">setVisible</span>(<span class="literal">true</span>);
        box3-&gt;<span class="built_in">setVisible</span>(<span class="literal">true</span>);
        node_boxes_parent-&gt;<span class="built_in">setPositionY</span>(if_boxes_original_y_position);
        fnt_box_1-&gt;<span class="built_in">setString</span>(StringUtils::format(<span class="string">&quot;%d/3&quot;</span>, ok_piece_cnt));
        fnt_box_2-&gt;<span class="built_in">setString</span>(StringUtils::format(<span class="string">&quot;%d/9&quot;</span>, ok_piece_cnt));
        fnt_box_3-&gt;<span class="built_in">setString</span>(StringUtils::format(<span class="string">&quot;%d/16&quot;</span>, ok_piece_cnt));
    &#125;
&#125;

<span class="comment">//更新左侧列表框里的缩略图的显示</span>
<span class="function"><span class="type">void</span> <span class="title">DialogPhoto::refresh_list_view_photo</span><span class="params">(<span class="type">int</span> photo_id)</span></span>
<span class="function"></span>&#123;
    <span class="keyword">if</span> (csb_root)
    &#123;
        <span class="keyword">auto</span> lsv = (ListView*)PUI::<span class="built_in">of_find_by_name</span>(csb_root, <span class="string">&quot;listview_photos&quot;</span>);
        <span class="keyword">if</span> (lsv)
        &#123;
            <span class="keyword">auto</span> panel = <span class="built_in">dynamic_cast</span>&lt;Layout*&gt;(lsv-&gt;<span class="built_in">getChildByTag</span>(photo_id));
            <span class="keyword">if</span> (panel)
            &#123;
                <span class="built_in">of_add_photo_one</span>(panel, photo_id, i_listview_item_normal_scale);
            &#125;
        &#125;
    &#125;
&#125;

<span class="comment">//检查是否需要发奖</span>
<span class="function"><span class="type">void</span> <span class="title">DialogPhoto::check_need_award_box</span><span class="params">(<span class="type">int</span> photo_id)</span></span>
<span class="function"></span>&#123;
    <span class="type">int</span> ok_piece_cnt = g.candy_photo_collect-&gt;<span class="built_in">of_get_photo_ok_piece_count</span>(photo_id);
    <span class="keyword">if</span> (ok_piece_cnt == <span class="number">3</span>)
    &#123;
        g.is_message_for_dialog = <span class="string">&quot;beforelineline,1;beforesame,1&quot;</span>;
        g.cm-&gt;<span class="built_in">of_award_by_string</span>(g.is_message_for_dialog);
        DialogAwardBox::<span class="built_in">make</span>(<span class="keyword">this</span>, <span class="number">999</span>, <span class="literal">nullptr</span>);
    &#125;
    <span class="keyword">else</span> <span class="keyword">if</span> (ok_piece_cnt == <span class="number">9</span>)
    &#123;
        g.is_message_for_dialog = <span class="string">&quot;beforebombbomb,1;beforesame,1;coin_little,100&quot;</span>;
        g.cm-&gt;<span class="built_in">of_award_by_string</span>(g.is_message_for_dialog);
        DialogAwardBox::<span class="built_in">make</span>(<span class="keyword">this</span>, <span class="number">999</span>, <span class="literal">nullptr</span>);
    &#125;
    <span class="keyword">else</span> <span class="keyword">if</span> (ok_piece_cnt == <span class="number">16</span>)
    &#123;
        <span class="keyword">auto</span> node_photo_one = PUI::<span class="built_in">of_find_by_name</span>(csb_root, <span class="string">&quot;node_photo_one&quot;</span>);
        PUI::<span class="built_in">of_find_by_name</span>(csb_root, <span class="string">&quot;node_pieces&quot;</span>)-&gt;<span class="built_in">setVisible</span>(<span class="literal">false</span>);
        <span class="comment">//拼完就把亮图显示出来，淡入</span>
        <span class="keyword">auto</span> sp_normal_one = (Sprite*)PUI::<span class="built_in">of_find_by_name</span>(node_photo_one, <span class="string">&quot;sp_photo_normal_bg&quot;</span>);
        PUI::<span class="built_in">of_sprite_set_texture</span>(sp_normal_one, <span class="built_in">of_get_photo_path_by_id</span>(photo_id));
        sp_normal_one-&gt;<span class="built_in">setVisible</span>(<span class="literal">true</span>);
        sp_normal_one-&gt;<span class="built_in">setOpacity</span>(<span class="number">0</span>);
        <span class="keyword">auto</span> act1 = FadeIn::<span class="built_in">create</span>(<span class="number">2.5f</span>);
        <span class="keyword">auto</span> act2 = CallFunc::<span class="built_in">create</span>(<span class="built_in">CC_CALLBACK_0</span>(DialogPhoto::of_callback_all_pieces_ok, <span class="keyword">this</span>, photo_id));
        <span class="keyword">auto</span> act = Sequence::<span class="built_in">create</span>(act1, act2, <span class="literal">nullptr</span>);
        sp_normal_one-&gt;<span class="built_in">runAction</span>(act);
    &#125;
&#125;

<span class="comment">//把单个的csb photo添加到指定的父节点上</span>
<span class="function"><span class="type">void</span> <span class="title">DialogPhoto::of_add_photo_one</span><span class="params">(Widget * l_widget_parent, <span class="type">int</span> li_photo_id, <span class="type">float</span> lf_scale)</span></span>
<span class="function"></span>&#123;
    l_widget_parent-&gt;<span class="built_in">removeAllChildren</span>();
    <span class="keyword">auto</span> l_node_csb = CSLoader::<span class="built_in">createNode</span>(<span class="string">&quot;csb_ui_photo/node_photo_one.csb&quot;</span>);
    l_node_csb-&gt;<span class="built_in">setScale</span>(lf_scale);
    l_widget_parent-&gt;<span class="built_in">addChild</span>(l_node_csb);
    <span class="keyword">auto</span> l_timeline_action_csb = CSLoader::<span class="built_in">createTimeline</span>(<span class="string">&quot;csb_ui_photo/node_photo_one.csb&quot;</span>);
    l_node_csb-&gt;<span class="built_in">runAction</span>(l_timeline_action_csb);
    l_timeline_action_csb-&gt;<span class="built_in">gotoFrameAndPause</span>(<span class="number">65</span>);<span class="comment">//这个csb有一个淡入的动画，是0到60帧，这里直接显示65帧，不需要淡入动画</span>

    <span class="comment">//查询该图拼完没有，如果没拼完就显示暗图和碎片，如果拼完了就显示亮图</span>
    <span class="type">int</span> li_ok_piece_cnt = g.candy_photo_collect-&gt;<span class="built_in">of_get_photo_ok_piece_count</span>(li_photo_id);
    <span class="keyword">if</span> (li_ok_piece_cnt &lt; PHOTO_COLLECT_PIECE_COUNT)
    &#123;
        <span class="comment">//显示底图</span>
        <span class="keyword">auto</span> l_sp_shadow_one = (Sprite*)PUI::<span class="built_in">of_find_by_name</span>(l_node_csb, <span class="string">&quot;sp_photo_shadow_bg&quot;</span>);
        l_sp_shadow_one-&gt;<span class="built_in">setVisible</span>(<span class="literal">true</span>);
        <span class="keyword">if</span> (kUseShader)
        &#123;
            PUI::<span class="built_in">of_sprite_set_texture</span>(l_sp_shadow_one, <span class="built_in">of_get_photo_path_by_id</span>(li_photo_id));
            PUI::<span class="built_in">of_node_set_gray</span>(l_sp_shadow_one);
        &#125;
        <span class="keyword">else</span>
        &#123;
            PUI::<span class="built_in">of_sprite_set_texture</span>(l_sp_shadow_one, <span class="built_in">of_get_gray_photo_path_by_id</span>(li_photo_id));
        &#125;
        <span class="comment">//显示碎片</span>
        <span class="keyword">auto</span> l_vector_pieces_array = g.candy_photo_collect-&gt;<span class="built_in">of_get_pieces</span>(li_photo_id);
        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; PHOTO_COLLECT_PIECE_COUNT; i++)
        &#123;
            <span class="keyword">auto</span> l_sprite_piece = (Sprite*)PUI::<span class="built_in">of_find_by_name</span>(l_node_csb, StringUtils::format(<span class="string">&quot;sp_piece%d&quot;</span>, i));
            l_sprite_piece-&gt;<span class="built_in">setTag</span>(i);
            <span class="type">int</span> li_piece_status = l_vector_pieces_array[i];
            <span class="keyword">if</span> (li_piece_status != <span class="number">2</span>)
            &#123;
                l_sprite_piece-&gt;<span class="built_in">setVisible</span>(<span class="literal">false</span>);<span class="comment">//未归位的碎片不显示</span>
                <span class="keyword">continue</span>;
            &#125;

            <span class="keyword">auto</span> piece_pos = l_sprite_piece-&gt;<span class="built_in">getPosition</span>();
            <span class="keyword">auto</span> piece_size = l_sprite_piece-&gt;<span class="built_in">getContentSize</span>();

            <span class="keyword">auto</span> sp_stencil = Sprite::<span class="built_in">create</span>(l_sprite_piece-&gt;<span class="built_in">getTexture</span>()-&gt;<span class="built_in">getPath</span>());
            <span class="keyword">auto</span> node_clip = ClippingNode::<span class="built_in">create</span>(sp_stencil);
            node_clip-&gt;<span class="built_in">setAlphaThreshold</span>(<span class="number">0</span>);
            node_clip-&gt;<span class="built_in">setInverted</span>(<span class="literal">false</span>);
            node_clip-&gt;<span class="built_in">setPosition</span>(<span class="built_in">Vec2</span>(piece_size.width / <span class="number">2</span>, piece_size.height / <span class="number">2</span>));
            l_sprite_piece-&gt;<span class="built_in">addChild</span>(node_clip);

            <span class="keyword">auto</span> sp_content = Sprite::<span class="built_in">create</span>(<span class="built_in">of_get_photo_path_by_id</span>(li_photo_id));
            sp_content-&gt;<span class="built_in">setAnchorPoint</span>(Vec2::ANCHOR_BOTTOM_LEFT);
            sp_content-&gt;<span class="built_in">setPosition</span>(<span class="built_in">Vec2</span>(<span class="number">10</span> - piece_pos.x, <span class="number">130</span> - piece_pos.y));
            node_clip-&gt;<span class="built_in">addChild</span>(sp_content);

            <span class="keyword">auto</span> sp_shield = Sprite::<span class="built_in">create</span>(StringUtils::format(<span class="string">&quot;photoes/ui/001_%d_1.png&quot;</span>, i));
            sp_shield-&gt;<span class="built_in">setPosition</span>(<span class="built_in">Vec2</span>(piece_size.width / <span class="number">2</span>, piece_size.height / <span class="number">2</span>));
            l_sprite_piece-&gt;<span class="built_in">addChild</span>(sp_shield);
        &#125;
        <span class="comment">//隐藏亮图</span>
        <span class="keyword">auto</span> sp_normal_one = (Sprite*)PUI::<span class="built_in">of_find_by_name</span>(l_node_csb, <span class="string">&quot;sp_photo_normal_bg&quot;</span>);
        sp_normal_one-&gt;<span class="built_in">setVisible</span>(<span class="literal">false</span>);
    &#125;
    <span class="keyword">else</span>
    &#123;
        <span class="comment">//隐藏底图</span>
        <span class="keyword">auto</span> l_sp_shadow_one = (Sprite*)PUI::<span class="built_in">of_find_by_name</span>(l_node_csb, <span class="string">&quot;sp_photo_shadow_bg&quot;</span>);
        l_sp_shadow_one-&gt;<span class="built_in">setVisible</span>(<span class="literal">false</span>);
        <span class="comment">//隐藏碎片，把所有碎片的父节点给隐藏</span>
        PUI::<span class="built_in">of_find_by_name</span>(l_node_csb, <span class="string">&quot;node_pieces&quot;</span>)-&gt;<span class="built_in">setVisible</span>(<span class="literal">false</span>);
        <span class="comment">//显示亮图</span>
        <span class="keyword">auto</span> sp_normal_one = (Sprite*)PUI::<span class="built_in">of_find_by_name</span>(l_node_csb, <span class="string">&quot;sp_photo_normal_bg&quot;</span>);
        PUI::<span class="built_in">of_sprite_set_texture</span>(sp_normal_one, <span class="built_in">of_get_photo_path_by_id</span>(li_photo_id));
    &#125;

    <span class="comment">//显示节日名，根据中英文决定谁不显示</span>
    <span class="keyword">auto</span> l_txt_photo_name_en = (Text*)PUI::<span class="built_in">of_find_by_name</span>(l_node_csb, <span class="string">&quot;txt_name_en&quot;</span>);
    l_txt_photo_name_en-&gt;<span class="built_in">setString</span>(g.candy_photo_collect-&gt;<span class="built_in">of_get_name</span>(li_photo_id, g.is_country));
    l_txt_photo_name_en-&gt;<span class="built_in">setVisible</span>(g.is_country == <span class="string">&quot;zh&quot;</span> ? <span class="literal">false</span> : <span class="literal">true</span>);
    <span class="keyword">auto</span> l_txt_photo_name_zh = (Text*)PUI::<span class="built_in">of_find_by_name</span>(l_node_csb, <span class="string">&quot;txt_name_zh&quot;</span>);
    l_txt_photo_name_zh-&gt;<span class="built_in">setString</span>(g.candy_photo_collect-&gt;<span class="built_in">of_get_name</span>(li_photo_id, g.is_country));
    l_txt_photo_name_zh-&gt;<span class="built_in">setVisible</span>(g.is_country == <span class="string">&quot;zh&quot;</span> ? <span class="literal">true</span> : <span class="literal">false</span>);

    <span class="comment">//隐藏节日说明</span>
    PUI::<span class="built_in">of_find_by_name</span>(l_node_csb, <span class="string">&quot;txt_info_en&quot;</span>)-&gt;<span class="built_in">setVisible</span>(<span class="literal">false</span>);
    PUI::<span class="built_in">of_find_by_name</span>(l_node_csb, <span class="string">&quot;txt_info_zh&quot;</span>)-&gt;<span class="built_in">setVisible</span>(<span class="literal">false</span>);
&#125;

<span class="comment">//根据photo id找到对应的图片路径</span>
<span class="function">string <span class="title">DialogPhoto::of_get_photo_path_by_id</span><span class="params">(<span class="type">int</span> li_photo_id)</span></span>
<span class="function"></span>&#123;
    <span class="keyword">return</span> StringUtils::format(<span class="string">&quot;photoes/normal/%03d_normal.png&quot;</span>, li_photo_id, li_photo_id);
&#125;

<span class="function">string <span class="title">DialogPhoto::of_get_gray_photo_path_by_id</span><span class="params">(<span class="type">int</span> li_photo_id)</span></span>
<span class="function"></span>&#123;
    <span class="keyword">return</span> StringUtils::format(<span class="string">&quot;photoes/gray/%03d_gray.png&quot;</span>, li_photo_id, li_photo_id);
&#125;

<span class="comment">//拼好之后，亮图淡入完成后的回调</span>
<span class="function"><span class="type">void</span> <span class="title">DialogPhoto::of_callback_all_pieces_ok</span><span class="params">(<span class="type">int</span> li_photo_id)</span></span>
<span class="function"></span>&#123;
    <span class="keyword">auto</span> l_layout_panel_for_touch = PUI::<span class="built_in">of_find_by_name</span>(csb_root, <span class="string">&quot;panel_for_touch&quot;</span>);

    <span class="comment">//显示节日说明</span>
    <span class="keyword">auto</span> photo_text_en = (Text*)PUI::<span class="built_in">of_find_by_name</span>(l_layout_panel_for_touch, <span class="string">&quot;txt_info_en&quot;</span>);
    <span class="keyword">auto</span> photo_text_zh = (Text*)PUI::<span class="built_in">of_find_by_name</span>(l_layout_panel_for_touch, <span class="string">&quot;txt_info_zh&quot;</span>);
    photo_text_en-&gt;<span class="built_in">setString</span>(g.candy_photo_collect-&gt;<span class="built_in">of_get_introduce</span>(li_photo_id, g.is_country));
    photo_text_zh-&gt;<span class="built_in">setString</span>(g.candy_photo_collect-&gt;<span class="built_in">of_get_introduce</span>(li_photo_id, g.is_country));
    photo_text_en-&gt;<span class="built_in">setVisible</span>(g.is_country == <span class="string">&quot;zh&quot;</span> ? <span class="literal">false</span> : <span class="literal">true</span>);
    photo_text_zh-&gt;<span class="built_in">setVisible</span>(g.is_country == <span class="string">&quot;zh&quot;</span> ? <span class="literal">true</span> : <span class="literal">false</span>);

    g.is_message_for_dialog = <span class="string">&quot;hammer,1;beforelineline,1;beforesame,1;coin_big,100;life_unlimited,1;beforebombbomb,1&quot;</span>;
    g.cm-&gt;<span class="built_in">of_award_by_string</span>(g.is_message_for_dialog);
    DialogAwardBox::<span class="built_in">make</span>(<span class="keyword">this</span>, <span class="number">999</span>, <span class="literal">nullptr</span>);
&#125;

<span class="function"><span class="type">void</span> <span class="title">DialogPhoto::of_work_after_piece_status_turn_to_ok</span><span class="params">(<span class="type">int</span> li_photo_id, Vec2 piece_pos)</span></span>
<span class="function"></span>&#123;
    <span class="comment">//根据拼好了多少个碎片来决定飞过去的光效飞到哪个宝箱上</span>
    <span class="type">int</span> li_ok_piece_cnt = g.candy_photo_collect-&gt;<span class="built_in">of_get_photo_ok_piece_count</span>(li_photo_id);

    <span class="comment">//默认飞向第三个宝箱</span>
    <span class="keyword">auto</span> l_node_fly_to = PUI::<span class="built_in">of_find_by_name</span>(csb_root, <span class="string">&quot;btn_albumgiftbox_3&quot;</span>);
    <span class="keyword">if</span> (li_ok_piece_cnt &lt;= <span class="number">3</span>) l_node_fly_to = PUI::<span class="built_in">of_find_by_name</span>(csb_root, <span class="string">&quot;btn_albumgiftbox_1&quot;</span>);
    <span class="keyword">else</span> <span class="keyword">if</span> (li_ok_piece_cnt &lt;= <span class="number">9</span>) l_node_fly_to = PUI::<span class="built_in">of_find_by_name</span>(csb_root, <span class="string">&quot;btn_albumgiftbox_2&quot;</span>);

    <span class="comment">//拼好一个碎片后，播放一个光效从碎片飞到宝箱上</span>
    <span class="keyword">auto</span> <span class="type">pos_fly_begin_t</span> = m_touching_piece_father_node-&gt;<span class="built_in">convertToWorldSpace</span>(piece_pos);
    <span class="keyword">auto</span> pos_fly_begin = csb_root-&gt;<span class="built_in">convertToNodeSpace</span>(<span class="type">pos_fly_begin_t</span>);
    <span class="keyword">auto</span> <span class="type">pos_fly_end_t</span> = l_node_fly_to-&gt;<span class="built_in">convertToWorldSpace</span>(<span class="built_in">Vec2</span>(<span class="number">114</span>, <span class="number">117</span>));
    <span class="keyword">auto</span> pos_fly_end = csb_root-&gt;<span class="built_in">convertToNodeSpace</span>(<span class="type">pos_fly_end_t</span>);

    <span class="keyword">auto</span> par = ParticleSystemQuad::<span class="built_in">create</span>(<span class="string">&quot;particle/particle_juneng_adding.plist&quot;</span>);
    par-&gt;<span class="built_in">setPosition</span>(pos_fly_begin);
    csb_root-&gt;<span class="built_in">addChild</span>(par);

    <span class="keyword">auto</span> act1 = MoveTo::<span class="built_in">create</span>(<span class="number">1</span>, pos_fly_end);
    <span class="keyword">auto</span> act2 = DelayTime::<span class="built_in">create</span>(<span class="number">0.4f</span>);
    <span class="keyword">auto</span> act3 = CallFunc::<span class="built_in">create</span>([<span class="keyword">this</span>, li_photo_id] &#123;
        <span class="comment">//拼好一个碎片后，更新宝箱上面的数字</span>
        <span class="built_in">refresh_award_box_label</span>(li_photo_id);
        <span class="comment">//拼好一个碎片后，检查是否发奖</span>
        <span class="built_in">check_need_award_box</span>(li_photo_id);
        <span class="comment">//拼好一个碎片后，更新左侧列表框里的缩略图的显示</span>
        <span class="built_in">refresh_list_view_photo</span>(li_photo_id);
    &#125;);
    <span class="keyword">auto</span> act4 = RemoveSelf::<span class="built_in">create</span>();
    par-&gt;<span class="built_in">runAction</span>(Sequence::<span class="built_in">create</span>(act1, act2, act3, act4, <span class="literal">nullptr</span>));
&#125;

<span class="meta">#<span class="keyword">pragma</span> endregion</span></code></pre>

<h1 id="过关之后的判断"><a href="#过关之后的判断" class="headerlink" title="过关之后的判断"></a>过关之后的判断</h1><pre><code class="highlight cpp"><span class="function"><span class="type">void</span> <span class="title">PanelFinish::of_photo_award_dialog</span><span class="params">()</span> </span>&#123;
    <span class="keyword">if</span> (g.ib_current_level_first_passed == <span class="literal">false</span>) <span class="keyword">return</span>;

    <span class="comment">//获取今天的日期</span>
    <span class="type">int</span> date_of_today = PFJava::<span class="built_in">of_get_today_number</span>();
    date_of_today = date_of_today % <span class="number">10000</span>;
    <span class="comment">//获取当前的关卡号</span>
    <span class="type">int</span> current_level = g.stages-&gt;<span class="built_in">of_get_passed_index_max</span>();

    <span class="comment">// 得到碎片图以及序号</span>
    <span class="type">int</span> li_photo_id = <span class="number">0</span>, li_piece_index = <span class="number">0</span>;
    <span class="type">bool</span> lb_piece_found = g.candy_photo_collect-&gt;<span class="built_in">of_get_award_piece</span>(g.game_model, date_of_today, current_level, <span class="number">5</span>, li_photo_id, li_piece_index);
    <span class="keyword">if</span> (!lb_piece_found) <span class="keyword">return</span>;
    g.candy_photo_collect-&gt;<span class="built_in">of_set_last_open_photo</span>(li_photo_id);
    g.candy_photo_collect-&gt;<span class="built_in">of_set_piece_status</span>(li_photo_id, li_piece_index, <span class="number">1</span>);


    <span class="comment">//  注意这是一个480的csb</span>
    string ls_csb = <span class="string">&quot;csb_ui_photo/dialog_photo_get_piece.csb&quot;</span>;

    <span class="keyword">auto</span> d1 = PUI::<span class="built_in">of_create_dialog</span>(layer, ls_csb, <span class="number">1999</span>, g.rrscale * <span class="number">2.0f</span>, <span class="number">45</span>);
    d1-&gt;<span class="built_in">setName</span>(<span class="string">&quot;csbnode_dialog_photo_get_piece&quot;</span>);
    g.<span class="built_in">of_set_ui_by_country</span>(d1);


    <span class="keyword">auto</span>  node_pos_photo_piece = PUI::<span class="built_in">of_find_by_name</span>(d1, <span class="string">&quot;node_pos_photo_piece&quot;</span>);
    <span class="keyword">auto</span>  sp_demo = PUI::<span class="built_in">of_find_by_name</span>(node_pos_photo_piece, <span class="string">&quot;sp_demo&quot;</span>);
    <span class="keyword">auto</span> pos0 = sp_demo-&gt;<span class="built_in">getPosition</span>();
    sp_demo-&gt;<span class="built_in">setVisible</span>(<span class="literal">false</span>);


    <span class="keyword">do</span> &#123;
        <span class="comment">// 采用动态创建的方式进行创建碎片</span>

        <span class="keyword">auto</span> l_single_node = CSLoader::<span class="built_in">createNode</span>(<span class="string">&quot;csb_ui_photo/node_photo_one.csb&quot;</span>);
        <span class="built_in">CC_BREAK_IF</span>(!l_single_node);

        <span class="keyword">auto</span> l_node_pieces = PUI::<span class="built_in">of_find_by_name</span>(l_single_node, <span class="string">&quot;node_pieces&quot;</span>);
        <span class="built_in">CC_BREAK_IF</span>(!l_node_pieces);

        string ls_piece_name = StringUtils::format(<span class="string">&quot;sp_piece%d&quot;</span>, li_piece_index);
        <span class="keyword">auto</span> n_piece1 = <span class="built_in">static_cast</span>&lt;Sprite*&gt;(l_node_pieces-&gt;<span class="built_in">getChildByName</span>(ls_piece_name));
        <span class="built_in">CC_BREAK_IF</span>(!n_piece1);

        Vec2 pos_cur_piece = n_piece1-&gt;<span class="built_in">getPosition</span>();
        Size size_cur_piece = n_piece1-&gt;<span class="built_in">getContentSize</span>();

        string ls_stencil_filename = n_piece1-&gt;<span class="built_in">getTexture</span>()-&gt;<span class="built_in">getPath</span>();
        <span class="built_in">CC_BREAK_IF</span>(!FileUtils::<span class="built_in">getInstance</span>()-&gt;<span class="built_in">isFileExist</span>(ls_stencil_filename));

        <span class="keyword">auto</span> l_sprite_stencil = Sprite::<span class="built_in">create</span>(ls_stencil_filename);
        <span class="built_in">CC_BREAK_IF</span>(!l_sprite_stencil);

        string ls_content_filename = StringUtils::format(<span class="string">&quot;photoes/normal/%03d_normal.png&quot;</span>, li_photo_id, li_photo_id);
        <span class="built_in">CC_BREAK_IF</span>(!FileUtils::<span class="built_in">getInstance</span>()-&gt;<span class="built_in">isFileExist</span>(ls_content_filename));

        <span class="keyword">auto</span> l_sprite_content = Sprite::<span class="built_in">create</span>(ls_content_filename);
        <span class="built_in">CC_BREAK_IF</span>(!l_sprite_content);

        l_sprite_content-&gt;<span class="built_in">setAnchorPoint</span>(Vec2::ANCHOR_BOTTOM_LEFT);
        l_sprite_content-&gt;<span class="built_in">setPosition</span>(<span class="built_in">Vec2</span>(<span class="number">10</span> - pos_cur_piece.x, <span class="number">130</span> - pos_cur_piece.y));

        <span class="keyword">auto</span> l_node_clip = ClippingNode::<span class="built_in">create</span>(l_sprite_stencil);
        l_node_clip-&gt;<span class="built_in">setAlphaThreshold</span>(<span class="number">0</span>);
        l_node_clip-&gt;<span class="built_in">setInverted</span>(<span class="literal">false</span>);
        l_node_clip-&gt;<span class="built_in">addChild</span>(l_sprite_content);
        l_node_clip-&gt;<span class="built_in">setScale</span>(<span class="number">0.45f</span>);
        node_pos_photo_piece-&gt;<span class="built_in">addChild</span>(l_node_clip);

        string ls_shield_filename = StringUtils::format(<span class="string">&quot;photoes/ui/001_%d_1.png&quot;</span>, li_piece_index);
        <span class="built_in">CC_BREAK_IF</span>(!FileUtils::<span class="built_in">getInstance</span>()-&gt;<span class="built_in">isFileExist</span>(ls_shield_filename));

        <span class="keyword">auto</span> l_sprite_shield = Sprite::<span class="built_in">create</span>(ls_shield_filename);
        <span class="built_in">CC_BREAK_IF</span>(!l_sprite_shield);
        l_sprite_shield-&gt;<span class="built_in">setScale</span>(<span class="number">0.45f</span>);

        node_pos_photo_piece-&gt;<span class="built_in">addChild</span>(l_sprite_shield);
    &#125; <span class="keyword">while</span> (<span class="number">0</span>);

    <span class="comment">// </span>
    <span class="keyword">auto</span> button_close = (Button*)PUI::<span class="built_in">of_find_by_name</span>(d1, <span class="string">&quot;button_close&quot;</span>);
    button_close-&gt;<span class="built_in">addClickEventListener</span>(<span class="built_in">CC_CALLBACK_0</span>(PanelFinish::of_photo_award_dialog_close, <span class="keyword">this</span>));

    <span class="keyword">auto</span> button_open = (Button*)PUI::<span class="built_in">of_find_by_name</span>(d1, <span class="string">&quot;button_open&quot;</span>);
    button_open-&gt;<span class="built_in">addClickEventListener</span>(<span class="built_in">CC_CALLBACK_0</span>(PanelFinish::of_photo_award_dialog_open, <span class="keyword">this</span>));

    g.<span class="built_in">of_track_function</span>(<span class="string">&quot;n_photo_collect_piece&quot;</span>);

    g.<span class="built_in">play_sound</span>(<span class="string">&quot;music/sound_gift_get.mp3&quot;</span>);

&#125;
<span class="function"><span class="type">void</span> <span class="title">PanelFinish::of_photo_award_dialog_open</span><span class="params">()</span> </span>&#123;
    PUI::<span class="built_in">of_find_by_name_set_visible</span>(layer, <span class="string">&quot;csbnode_dialog_photo_get_piece&quot;</span>, <span class="literal">false</span>);

    DialogPhoto::<span class="built_in">make</span>(layer, <span class="number">1999</span>, <span class="literal">nullptr</span>);

&#125;
<span class="function"><span class="type">void</span> <span class="title">PanelFinish::of_photo_award_dialog_close</span><span class="params">()</span> </span>&#123;
    <span class="keyword">auto</span> d1 = PUI::<span class="built_in">of_find_by_name</span>(layer, <span class="string">&quot;csbnode_dialog_photo_get_piece&quot;</span>);
    d1-&gt;<span class="built_in">setVisible</span>(<span class="literal">false</span>);

&#125;</code></pre>

<h1 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h1><p>保存为photo_collect_config.json，放在config目录下。</p>
<pre><code class="highlight json"><span class="punctuation">&#123;</span>
	<span class="attr">&quot;说明1&quot;</span><span class="punctuation">:</span> <span class="string">&quot;type_date是日期类型的配置，日期类型的配置里不能有level_begin字段&quot;</span><span class="punctuation">,</span>
	<span class="attr">&quot;说明2&quot;</span><span class="punctuation">:</span> <span class="string">&quot;type_level是关卡类型的配置，关卡类型的配置里不能有date_begin和date_end字段&quot;</span><span class="punctuation">,</span>
	<span class="attr">&quot;说明3&quot;</span><span class="punctuation">:</span> <span class="string">&quot;id这个字段必须是大于0的整数，并且我们约定1到500表示日期类配置，501到999表示关卡类配置。当然你也可以不遵守这个约定，不影响程序正常运行。这个id的作用是用来找到对应的图片资源&quot;</span><span class="punctuation">,</span>
	<span class="attr">&quot;说明4&quot;</span><span class="punctuation">:</span> <span class="string">&quot;日期类配置，date_end必须大于或等于date_begin，等于就表示这个节日只有一天&quot;</span><span class="punctuation">,</span>
	<span class="attr">&quot;说明5&quot;</span><span class="punctuation">:</span> <span class="string">&quot;关卡类配置，level_begin必须各不相同&quot;</span><span class="punctuation">,</span>
	<span class="attr">&quot;说明6&quot;</span><span class="punctuation">:</span> <span class="string">&quot;日期类配置，同一个日期区间可能会对应多张图，比方说父亲节有3张图，现在到父亲节的日期了，并且3张图都没解锁，那么谁先解锁谁后解锁，可以再加一个关卡号来筛选，也就是level_limit这个字段，这个字段可有可无&quot;</span><span class="punctuation">,</span>
	<span class="attr">&quot;type_date&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">&#123;</span>
		<span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span>
		<span class="attr">&quot;name_en&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Christmas Day&quot;</span><span class="punctuation">,</span>
		<span class="attr">&quot;name_zh&quot;</span><span class="punctuation">:</span> <span class="string">&quot;圣诞节&quot;</span><span class="punctuation">,</span>
		<span class="attr">&quot;info_en&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Luna is going to have a wonderful Christmas with him(or her), Who would be the lucky one?&quot;</span><span class="punctuation">,</span>
		<span class="attr">&quot;info_zh&quot;</span><span class="punctuation">:</span> <span class="string">&quot;露娜将会跟他（她）在这一起度过一个愉快的圣诞节，那位幸运儿回是谁呢？&quot;</span><span class="punctuation">,</span>
		<span class="attr">&quot;date_begin&quot;</span><span class="punctuation">:</span> <span class="number">1201</span><span class="punctuation">,</span>
		<span class="attr">&quot;date_end&quot;</span><span class="punctuation">:</span> <span class="number">1231</span>
	<span class="punctuation">&#125;</span><span class="punctuation">,</span> <span class="punctuation">&#123;</span>
		<span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span>
		<span class="attr">&quot;name_en&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Valentine&#x27;s Day&quot;</span><span class="punctuation">,</span>
		<span class="attr">&quot;name_zh&quot;</span><span class="punctuation">:</span> <span class="string">&quot;情人节&quot;</span><span class="punctuation">,</span>
		<span class="attr">&quot;info_en&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Luna received a beautiful bouquet of flowers, Who gave her?&quot;</span><span class="punctuation">,</span>
		<span class="attr">&quot;info_zh&quot;</span><span class="punctuation">:</span> <span class="string">&quot;露娜收到一束漂亮的花，是谁送给她的？&quot;</span><span class="punctuation">,</span>
		<span class="attr">&quot;date_begin&quot;</span><span class="punctuation">:</span> <span class="number">201</span><span class="punctuation">,</span>
		<span class="attr">&quot;date_end&quot;</span><span class="punctuation">:</span> <span class="number">218</span>
	<span class="punctuation">&#125;</span><span class="punctuation">,</span> <span class="punctuation">&#123;</span>
		<span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span>
		<span class="attr">&quot;name_en&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Women&#x27;s Day&quot;</span><span class="punctuation">,</span>
		<span class="attr">&quot;name_zh&quot;</span><span class="punctuation">:</span> <span class="string">&quot;妇女节&quot;</span><span class="punctuation">,</span>
		<span class="attr">&quot;info_en&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Make your own life!&quot;</span><span class="punctuation">,</span>
		<span class="attr">&quot;info_zh&quot;</span><span class="punctuation">:</span> <span class="string">&quot;创造属于你自己的生活吧！&quot;</span><span class="punctuation">,</span>
		<span class="attr">&quot;date_begin&quot;</span><span class="punctuation">:</span> <span class="number">301</span><span class="punctuation">,</span>
		<span class="attr">&quot;date_end&quot;</span><span class="punctuation">:</span> <span class="number">310</span>
	<span class="punctuation">&#125;</span><span class="punctuation">,</span> <span class="punctuation">&#123;</span>
		<span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">4</span><span class="punctuation">,</span>
		<span class="attr">&quot;name_en&quot;</span><span class="punctuation">:</span> <span class="string">&quot;St.Patrick&#x27;s Day&quot;</span><span class="punctuation">,</span>
		<span class="attr">&quot;name_zh&quot;</span><span class="punctuation">:</span> <span class="string">&quot;圣帕特里克节&quot;</span><span class="punctuation">,</span>
		<span class="attr">&quot;info_en&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Let the shamrocks start your luck.&quot;</span><span class="punctuation">,</span>
		<span class="attr">&quot;info_zh&quot;</span><span class="punctuation">:</span> <span class="string">&quot;让三叶草给你带来好运！&quot;</span><span class="punctuation">,</span>
		<span class="attr">&quot;date_begin&quot;</span><span class="punctuation">:</span> <span class="number">311</span><span class="punctuation">,</span>
		<span class="attr">&quot;date_end&quot;</span><span class="punctuation">:</span> <span class="number">318</span>
	<span class="punctuation">&#125;</span><span class="punctuation">,</span> <span class="punctuation">&#123;</span>
		<span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">5</span><span class="punctuation">,</span>
		<span class="attr">&quot;name_en&quot;</span><span class="punctuation">:</span> <span class="string">&quot;April Fool&#x27;s Day&quot;</span><span class="punctuation">,</span>
		<span class="attr">&quot;name_zh&quot;</span><span class="punctuation">:</span> <span class="string">&quot;愚人节&quot;</span><span class="punctuation">,</span>
		<span class="attr">&quot;info_en&quot;</span><span class="punctuation">:</span> <span class="string">&quot;A bottle of wine will be delivered in 5 mins.&quot;</span><span class="punctuation">,</span>
		<span class="attr">&quot;info_zh&quot;</span><span class="punctuation">:</span> <span class="string">&quot;5分钟后会有人给你送一瓶葡萄酒。&quot;</span><span class="punctuation">,</span>
		<span class="attr">&quot;date_begin&quot;</span><span class="punctuation">:</span> <span class="number">327</span><span class="punctuation">,</span>
		<span class="attr">&quot;date_end&quot;</span><span class="punctuation">:</span> <span class="number">402</span>
	<span class="punctuation">&#125;</span><span class="punctuation">,</span> <span class="punctuation">&#123;</span>
		<span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">6</span><span class="punctuation">,</span>
		<span class="attr">&quot;name_en&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Easter&quot;</span><span class="punctuation">,</span>
		<span class="attr">&quot;name_zh&quot;</span><span class="punctuation">:</span> <span class="string">&quot;复活节&quot;</span><span class="punctuation">,</span>
		<span class="attr">&quot;info_en&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Go and find the eggs hidden in the game.&quot;</span><span class="punctuation">,</span>
		<span class="attr">&quot;info_zh&quot;</span><span class="punctuation">:</span> <span class="string">&quot;去寻找游戏里的彩蛋吧！&quot;</span><span class="punctuation">,</span>
		<span class="attr">&quot;date_begin&quot;</span><span class="punctuation">:</span> <span class="number">406</span><span class="punctuation">,</span>
		<span class="attr">&quot;date_end&quot;</span><span class="punctuation">:</span> <span class="number">428</span>
	<span class="punctuation">&#125;</span><span class="punctuation">,</span> <span class="punctuation">&#123;</span>
		<span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">7</span><span class="punctuation">,</span>
		<span class="attr">&quot;name_en&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Mother&#x27;s Day&quot;</span><span class="punctuation">,</span>
		<span class="attr">&quot;name_zh&quot;</span><span class="punctuation">:</span> <span class="string">&quot;母亲节&quot;</span><span class="punctuation">,</span>
		<span class="attr">&quot;info_en&quot;</span><span class="punctuation">:</span> <span class="string">&quot;This is a photo of Luna childhood when she was with her mom on Mother&#x27;s Day&quot;</span><span class="punctuation">,</span>
		<span class="attr">&quot;info_zh&quot;</span><span class="punctuation">:</span> <span class="string">&quot;这是露娜小时候陪妈妈一起过母亲节的照片！&quot;</span><span class="punctuation">,</span>
		<span class="attr">&quot;date_begin&quot;</span><span class="punctuation">:</span> <span class="number">501</span><span class="punctuation">,</span>
		<span class="attr">&quot;date_end&quot;</span><span class="punctuation">:</span> <span class="number">518</span>
	<span class="punctuation">&#125;</span><span class="punctuation">,</span> <span class="punctuation">&#123;</span>
		<span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">8</span><span class="punctuation">,</span>
		<span class="attr">&quot;name_en&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Halloween&quot;</span><span class="punctuation">,</span>
		<span class="attr">&quot;name_zh&quot;</span><span class="punctuation">:</span> <span class="string">&quot;万圣节&quot;</span><span class="punctuation">,</span>
		<span class="attr">&quot;info_en&quot;</span><span class="punctuation">:</span> <span class="string">&quot;It was the first time that she attend Halloween party when she was 6 years old.&quot;</span><span class="punctuation">,</span>
		<span class="attr">&quot;info_zh&quot;</span><span class="punctuation">:</span> <span class="string">&quot;这是露娜6岁时参加万圣节派对的照片，她获得了很多糖果！&quot;</span><span class="punctuation">,</span>
		<span class="attr">&quot;date_begin&quot;</span><span class="punctuation">:</span> <span class="number">1020</span><span class="punctuation">,</span>
		<span class="attr">&quot;date_end&quot;</span><span class="punctuation">:</span> <span class="number">1120</span>
	<span class="punctuation">&#125;</span><span class="punctuation">,</span> <span class="punctuation">&#123;</span>
		<span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">9</span><span class="punctuation">,</span>
		<span class="attr">&quot;name_en&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Father&#x27;s Day&quot;</span><span class="punctuation">,</span>
		<span class="attr">&quot;name_zh&quot;</span><span class="punctuation">:</span> <span class="string">&quot;父亲节&quot;</span><span class="punctuation">,</span>
		<span class="attr">&quot;info_en&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Today is Father&#x27;s Day.I send dad a beautiful bouquet of flowers.&quot;</span><span class="punctuation">,</span>
		<span class="attr">&quot;info_zh&quot;</span><span class="punctuation">:</span> <span class="string">&quot;父亲节到了，送爸爸一束美丽的鲜花！&quot;</span><span class="punctuation">,</span>
		<span class="attr">&quot;date_begin&quot;</span><span class="punctuation">:</span> <span class="number">610</span><span class="punctuation">,</span>
		<span class="attr">&quot;date_end&quot;</span><span class="punctuation">:</span> <span class="number">630</span><span class="punctuation">,</span>
		<span class="attr">&quot;level_limit&quot;</span><span class="punctuation">:</span> <span class="number">60</span>
	<span class="punctuation">&#125;</span><span class="punctuation">,</span> <span class="punctuation">&#123;</span>
		<span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">10</span><span class="punctuation">,</span>
		<span class="attr">&quot;name_en&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Father&#x27;s Day&quot;</span><span class="punctuation">,</span>
		<span class="attr">&quot;name_zh&quot;</span><span class="punctuation">:</span> <span class="string">&quot;父亲节&quot;</span><span class="punctuation">,</span>
		<span class="attr">&quot;info_en&quot;</span><span class="punctuation">:</span> <span class="string">&quot;On Father&#x27;s Day,I prepared a lot of gifts for my father.&quot;</span><span class="punctuation">,</span>
		<span class="attr">&quot;info_zh&quot;</span><span class="punctuation">:</span> <span class="string">&quot;在父亲节这天，我给爸爸准备了很多的礼物。&quot;</span><span class="punctuation">,</span>
		<span class="attr">&quot;date_begin&quot;</span><span class="punctuation">:</span> <span class="number">610</span><span class="punctuation">,</span>
		<span class="attr">&quot;date_end&quot;</span><span class="punctuation">:</span> <span class="number">630</span><span class="punctuation">,</span>
		<span class="attr">&quot;level_limit&quot;</span><span class="punctuation">:</span> <span class="number">50</span>
	<span class="punctuation">&#125;</span><span class="punctuation">,</span> <span class="punctuation">&#123;</span>
		<span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">11</span><span class="punctuation">,</span>
		<span class="attr">&quot;name_en&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Independence Day&quot;</span><span class="punctuation">,</span>
		<span class="attr">&quot;name_zh&quot;</span><span class="punctuation">:</span> <span class="string">&quot;独立日&quot;</span><span class="punctuation">,</span>
		<span class="attr">&quot;info_en&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Today is Independence Day,Luna dressed up as a holiday costume,ready to go to a community party.&quot;</span><span class="punctuation">,</span>
		<span class="attr">&quot;info_zh&quot;</span><span class="punctuation">:</span> <span class="string">&quot;今天是独立日，露娜装扮了节日的装束，准备去参加社区的派对&quot;</span><span class="punctuation">,</span>
		<span class="attr">&quot;date_begin&quot;</span><span class="punctuation">:</span> <span class="number">701</span><span class="punctuation">,</span>
		<span class="attr">&quot;date_end&quot;</span><span class="punctuation">:</span> <span class="number">720</span>
	<span class="punctuation">&#125;</span><span class="punctuation">]</span><span class="punctuation">,</span>
	<span class="attr">&quot;type_level&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">&#123;</span>
		<span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">501</span><span class="punctuation">,</span>
		<span class="attr">&quot;name_en&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Go to the beach&quot;</span><span class="punctuation">,</span>
		<span class="attr">&quot;name_zh&quot;</span><span class="punctuation">:</span> <span class="string">&quot;去沙滩&quot;</span><span class="punctuation">,</span>
		<span class="attr">&quot;info_en&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Luna had a good time on the beach!&quot;</span><span class="punctuation">,</span>
		<span class="attr">&quot;info_zh&quot;</span><span class="punctuation">:</span> <span class="string">&quot;露娜在沙滩玩得很开心！&quot;</span><span class="punctuation">,</span>
		<span class="attr">&quot;level_begin&quot;</span><span class="punctuation">:</span> <span class="number">50</span>
	<span class="punctuation">&#125;</span><span class="punctuation">,</span> <span class="punctuation">&#123;</span>
		<span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">502</span><span class="punctuation">,</span>
		<span class="attr">&quot;name_en&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Making Chocolate&quot;</span><span class="punctuation">,</span>
		<span class="attr">&quot;name_zh&quot;</span><span class="punctuation">:</span> <span class="string">&quot;爱心巧克力&quot;</span><span class="punctuation">,</span>
		<span class="attr">&quot;info_en&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Luna&#x27;s making chocolate hearts.Who will receive them?&quot;</span><span class="punctuation">,</span>
		<span class="attr">&quot;info_zh&quot;</span><span class="punctuation">:</span> <span class="string">&quot;露娜在做爱心巧克力，谁会收到它呢？&quot;</span><span class="punctuation">,</span>
		<span class="attr">&quot;level_begin&quot;</span><span class="punctuation">:</span> <span class="number">30</span>
	<span class="punctuation">&#125;</span><span class="punctuation">,</span> <span class="punctuation">&#123;</span>
		<span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">503</span><span class="punctuation">,</span>
		<span class="attr">&quot;name_en&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Hold a Dance&quot;</span><span class="punctuation">,</span>
		<span class="attr">&quot;name_zh&quot;</span><span class="punctuation">:</span> <span class="string">&quot;舞会&quot;</span><span class="punctuation">,</span>
		<span class="attr">&quot;info_en&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Who will invite Luna for first dance on the ball?&quot;</span><span class="punctuation">,</span>
		<span class="attr">&quot;info_zh&quot;</span><span class="punctuation">:</span> <span class="string">&quot;舞会上，谁有幸邀请露娜跳第一支舞？&quot;</span><span class="punctuation">,</span>
		<span class="attr">&quot;level_begin&quot;</span><span class="punctuation">:</span> <span class="number">60</span>
	<span class="punctuation">&#125;</span><span class="punctuation">,</span> <span class="punctuation">&#123;</span>
		<span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">504</span><span class="punctuation">,</span>
		<span class="attr">&quot;name_en&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Play the Guitar&quot;</span><span class="punctuation">,</span>
		<span class="attr">&quot;name_zh&quot;</span><span class="punctuation">:</span> <span class="string">&quot;弹吉他&quot;</span><span class="punctuation">,</span>
		<span class="attr">&quot;info_en&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Guess which tune will James play for Luna today?&quot;</span><span class="punctuation">,</span>
		<span class="attr">&quot;info_zh&quot;</span><span class="punctuation">:</span> <span class="string">&quot;猜猜詹姆斯今天想为露娜弹什么曲子？&quot;</span><span class="punctuation">,</span>
		<span class="attr">&quot;level_begin&quot;</span><span class="punctuation">:</span> <span class="number">90</span>
	<span class="punctuation">&#125;</span><span class="punctuation">,</span> <span class="punctuation">&#123;</span>
		<span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">505</span><span class="punctuation">,</span>
		<span class="attr">&quot;name_en&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Make Up&quot;</span><span class="punctuation">,</span>
		<span class="attr">&quot;name_zh&quot;</span><span class="punctuation">:</span> <span class="string">&quot;化妆&quot;</span><span class="punctuation">,</span>
		<span class="attr">&quot;info_en&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Luna is dressing herself up.Who will she hang out with?&quot;</span><span class="punctuation">,</span>
		<span class="attr">&quot;info_zh&quot;</span><span class="punctuation">:</span> <span class="string">&quot;露娜在精心打扮，她待会儿要去见谁？&quot;</span><span class="punctuation">,</span>
		<span class="attr">&quot;level_begin&quot;</span><span class="punctuation">:</span> <span class="number">120</span>
	<span class="punctuation">&#125;</span><span class="punctuation">,</span> <span class="punctuation">&#123;</span>
		<span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">506</span><span class="punctuation">,</span>
		<span class="attr">&quot;name_en&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Watch Stars&quot;</span><span class="punctuation">,</span>
		<span class="attr">&quot;name_zh&quot;</span><span class="punctuation">:</span> <span class="string">&quot;看星星&quot;</span><span class="punctuation">,</span>
		<span class="attr">&quot;info_en&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Puff feels like seeing a starry night with Luna.&quot;</span><span class="punctuation">,</span>
		<span class="attr">&quot;info_zh&quot;</span><span class="punctuation">:</span> <span class="string">&quot;普夫好像和它的主人一起看星空呢！&quot;</span><span class="punctuation">,</span>
		<span class="attr">&quot;level_begin&quot;</span><span class="punctuation">:</span> <span class="number">160</span>
	<span class="punctuation">&#125;</span><span class="punctuation">,</span> <span class="punctuation">&#123;</span>
		<span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">507</span><span class="punctuation">,</span>
		<span class="attr">&quot;name_en&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Candlelight Dinner&quot;</span><span class="punctuation">,</span>
		<span class="attr">&quot;name_zh&quot;</span><span class="punctuation">:</span> <span class="string">&quot;烛光晚餐&quot;</span><span class="punctuation">,</span>
		<span class="attr">&quot;info_en&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Who will Luna have candlelight dinner with?&quot;</span><span class="punctuation">,</span>
		<span class="attr">&quot;info_zh&quot;</span><span class="punctuation">:</span> <span class="string">&quot;邀请露娜共进晚餐的那位是谁呢？&quot;</span><span class="punctuation">,</span>
		<span class="attr">&quot;level_begin&quot;</span><span class="punctuation">:</span> <span class="number">200</span>
	<span class="punctuation">&#125;</span><span class="punctuation">]</span>
<span class="punctuation">&#125;</span></code></pre>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://615737749.github.io/2021/04/16/03Knowledge/base64/base64001/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="porridgechen890">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="porridgechen890的笔记">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | porridgechen890的笔记">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/04/16/03Knowledge/base64/base64001/" class="post-title-link" itemprop="url">base64介绍</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-04-16 14:13:10" itemprop="dateCreated datePublished" datetime="2021-04-16T14:13:10+08:00">2021-04-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/03%E7%9F%A5%E8%AF%86%E7%82%B9/" itemprop="url" rel="index"><span itemprop="name">03知识点</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="一句话说明"><a href="#一句话说明" class="headerlink" title="一句话说明"></a>一句话说明</h1><p>base64是一种用64个字符来表示任意二进制数据的方法。<br>把3字节的二进制数据编码成4字节的文本数据。</p>
<h1 id="详细解释"><a href="#详细解释" class="headerlink" title="详细解释"></a>详细解释</h1><ol>
<li><p>原则</p>
<p> 二进制文件中包含很多无法显示和打印的字符。所以我们需要把不可显示的字符转化成可显示的字符。</p>
</li>
<li><p>是哪64个字符</p>
<p> 26个英文字母两组，分大小写，共52个。0到9共10个。一个 <code>+</code> ，一个 <code>/</code> 。凑齐64个。</p>
</li>
<li><p>怎么转</p>
<p> 拿到二进制数据后，3个字节一组，共24位，分成4组，6位一组。即 <code>3*8=4*6</code> 。</p>
<p> 现在得到了4组，每一组前边加两个0，就成了4组8位，即4个字节。</p>
</li>
<li><p>为什么偏偏是64</p>
<p> 6位二进制有2的6次方种可能，就是64种可能。</p>
</li>
<li><p>二进制数据的字节数量不是3的倍数怎么办？</p>
<p> 假如每3个字节切一刀，切到最后剩一个或两个字节怎么办？规则是在编码的末尾加一个或两个等号。</p>
</li>
<li><p>base64编码的变种</p>
<p> 为了能写在URL中， <code>+</code> 和 <code>/</code> 变成了 <code>-</code> 和 <code>_</code> 。</p>
</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" title="上一页" aria-label="上一页" href="/page/6/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/6/">6</a><span class="page-number current">7</span><a class="page-number" href="/page/8/">8</a><a class="extend next" rel="next" title="下一页" aria-label="下一页" href="/page/8/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 1375 – 
    <span itemprop="copyrightYear">2024</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">porridgechen890</span>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/pangu@4.0.7/dist/browser/pangu.min.js" integrity="sha256-j+yj56cdEY2CwkVtGyz18fNybFGpMGJ8JxG3GSyO2+I=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script>

  






  






        <style>
            [bg-lazy] {
                background-image: none !important;
                background-color: #eee !important;
            }
        </style>
        <script>
            window.imageLazyLoadSetting = {
                isSPA: false,
                preloadRatio: 3,
                processImages: null,
            };
        </script><script>window.addEventListener("load",function(){var t=/\.(gif|jpg|jpeg|tiff|png)$/i,r=/^data:image\/[a-z]+;base64,/;Array.prototype.slice.call(document.querySelectorAll("img[data-original]")).forEach(function(a){var e=a.parentNode;"A"===e.tagName&&(e.href.match(t)||e.href.match(r))&&(e.href=a.dataset.original)})});</script><script>(r=>{r.imageLazyLoadSetting.processImages=t;var a=r.imageLazyLoadSetting.isSPA,o=r.imageLazyLoadSetting.preloadRatio||1,d=i();function i(){var t=Array.prototype.slice.call(document.querySelectorAll("img[data-original]")),e=Array.prototype.slice.call(document.querySelectorAll("[bg-lazy]"));return t.concat(e)}function t(t){(a||t)&&(d=i());for(var e,n=0;n<d.length;n++)0<=(e=(e=d[n]).getBoundingClientRect()).bottom&&0<=e.left&&e.top<=(r.innerHeight*o||document.documentElement.clientHeight*o)&&(()=>{var t,e,a,o,i=d[n];e=function(){d=d.filter(function(t){return i!==t}),r.imageLazyLoadSetting.onImageLoaded&&r.imageLazyLoadSetting.onImageLoaded(i)},(t=i).dataset.loaded||(t.hasAttribute("bg-lazy")?(t.removeAttribute("bg-lazy"),e&&e()):(a=new Image,o=t.getAttribute("data-original"),a.onload=function(){t.src=o,t.removeAttribute("data-original"),t.setAttribute("data-loaded",!0),e&&e()},a.onerror=function(){t.removeAttribute("data-original"),t.setAttribute("data-loaded",!1),t.src=o},t.src!==o&&(a.src=o)))})()}function e(){clearTimeout(t.tId),t.tId=setTimeout(t,500)}t(),document.addEventListener("scroll",e),r.addEventListener("resize",e),r.addEventListener("orientationchange",e)})(this);</script></body>
</html>
